<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoe Inventory System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e8e6e3;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #f5f3f0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 30px;
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #c8c6c3;
            font-weight: 500;
        }

        .tab:hover {
            background: #3a3a3a;
            border-color: #4a4a4a;
        }

        .tab.active {
            background: #f5f3f0;
            color: #1a1a1a;
            border-color: #f5f3f0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-card {
            background: #252525;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #d8d6d3;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 2px solid #3a3a3a;
            border-radius: 12px;
            color: #e8e6e3;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f5f3f0;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        button {
            padding: 12px 30px;
            background: #f5f3f0;
            color: #1a1a1a;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        button:hover {
            background: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245,243,240,0.3);
        }

        .btn-secondary {
            background: #3a3a3a;
            color: #e8e6e3;
        }

        .btn-secondary:hover {
            background: #4a4a4a;
        }

        .btn-danger {
            background: #d32f2f;
            color: white;
        }

        .btn-danger:hover {
            background: #b71c1c;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .shoe-card {
            background: #252525;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .shoe-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .shoe-card h3 {
            color: #f5f3f0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .shoe-detail {
            margin: 8px 0;
            color: #c8c6c3;
            font-size: 14px;
        }

        .shoe-detail strong {
            color: #e8e6e3;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .card-actions button {
            flex: 1;
            padding: 8px;
            font-size: 13px;
        }

        .bulk-entry {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
        }

        .color-group {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #3a3a3a;
        }

        .color-header {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .size-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 8px;
            align-items: end;
        }

        .sales-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .payment-split {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
        }

        .report-card {
            background: #252525;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .report-stat {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #3a3a3a;
        }

        .report-stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #c8c6c3;
        }

        .stat-value {
            color: #f5f3f0;
            font-weight: 600;
            font-size: 1.1em;
        }

        .sales-list {
            margin-top: 20px;
        }

        .sale-item {
            background: #252525;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .sale-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #f5f3f0;
            font-weight: 600;
        }

        .sale-details {
            color: #c8c6c3;
            font-size: 14px;
        }

        .color-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #3a3a3a;
            border-radius: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #252525;
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
            margin-top: 5px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #3a3a3a;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: #2a2a2a;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #252525;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: #d32f2f;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }

        @media (max-width: 768px) {
            .sales-form {
                grid-template-columns: 1fr;
            }

            .size-row {
                grid-template-columns: 1fr;
            }

            .inventory-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shoe Inventory System</h1>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('inventory')">Inventory</div>
            <div class="tab" onclick="switchTab('sales')">Sales</div>
            <div class="tab" onclick="switchTab('transfers')">Transfers</div>
            <div class="tab" onclick="switchTab('report')">Reports</div>
        </div>

        <!-- INVENTORY TAB -->
        <div id="inventory" class="tab-content active">
            <div class="form-card">
                <h2 style="margin-bottom: 20px;">Add Inventory</h2>
                <form id="inventoryForm">
                    <div class="form-group">
                        <label>Inventory Date</label>
                        <input type="date" id="invDate" required>
                    </div>
                    <div class="form-group">
                        <label>Shoe Name</label>
                        <input type="text" id="shoeName" placeholder="e.g., Nike Air Max" required>
                    </div>
                    <div class="form-group">
                        <label>ATNO (Article Number)</label>
                        <input type="text" id="atno" placeholder="N/A" value="N/A">
                    </div>
                    <div class="form-group">
                        <label>Supplier Name</label>
                        <input type="text" id="supplierName" placeholder="Supplier name">
                    </div>
                    <div class="form-group">
                        <label>Cost per Pair</label>
                        <input type="number" id="costPerPair" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Inventory Entry (by Color)</label>
                        <div class="bulk-entry">
                            <div id="colorGroups"></div>
                            <button type="button" onclick="addColorGroup()" class="btn-secondary">+ Add Color</button>
                        </div>
                    </div>
                    <button type="submit">Add to Inventory</button>
                </form>
            </div>

            <h2 style="margin-bottom: 15px;">Current Inventory</h2>
            <div id="inventoryList" class="inventory-grid"></div>
        </div>

        <!-- SALES TAB -->
        <div id="sales" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 20px;">Record Sale</h2>
                <form id="salesForm">
                    <div class="sales-form">
                        <div>
                            <div class="form-group">
                                <label>Sale Date</label>
                                <input type="date" id="saleDate" required>
                            </div>
                            <div class="form-group search-box">
                                <label>Search Shoe</label>
                                <input type="text" id="shoeSearch" placeholder="Type to search..." autocomplete="off">
                                <div id="searchResults" class="search-results" style="display: none;"></div>
                            </div>
                            <div class="form-group">
                                <label>Selected Shoe</label>
                                <input type="text" id="selectedShoe" readonly>
                            </div>
                            <div class="form-group">
                                <label>Customer Name (Optional)</label>
                                <input type="text" id="customerName" placeholder="Customer name">
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>Available Colors</label>
                                <select id="saleColor" required>
                                    <option value="">Select shoe first</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Available Sizes</label>
                                <select id="saleSize" required>
                                    <option value="">Select color first</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantity (Pairs)</label>
                                <input type="number" id="saleQty" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Price per Pair</label>
                                <input type="number" id="salePrice" min="0" step="0.01" required>
                            </div>
                        </div>
                    </div>

                    <div class="payment-split">
                        <h3 style="margin-bottom: 15px;">Payment Method</h3>
                        <div class="form-group">
                            <label>M-Pesa Amount</label>
                            <input type="number" id="mpesaAmount" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Cash Amount</label>
                            <input type="number" id="cashAmount" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Total: <span id="totalAmount">0.00</span></label>
                        </div>
                    </div>

                    <button type="submit" style="margin-top: 20px;">Record Sale</button>
                </form>
            </div>

            <h2 style="margin-bottom: 15px;">Recent Sales</h2>
            <div id="salesList" class="sales-list"></div>
        </div>

        <!-- TRANSFERS TAB -->
        <div id="transfers" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 20px;">Record Transfer</h2>
                <form id="transferForm">
                    <div class="sales-form">
                        <div>
                            <div class="form-group">
                                <label>Transfer Date</label>
                                <input type="date" id="transferDate" required>
                            </div>
                            <div class="form-group search-box">
                                <label>Search Shoe</label>
                                <input type="text" id="transferShoeSearch" placeholder="Type to search..." autocomplete="off">
                                <div id="transferSearchResults" class="search-results" style="display: none;"></div>
                            </div>
                            <div class="form-group">
                                <label>Selected Shoe</label>
                                <input type="text" id="transferSelectedShoe" readonly>
                            </div>
                            <div class="form-group">
                                <label>Transfer To (Location)</label>
                                <input type="text" id="transferLocation" placeholder="e.g., Downtown Store" required>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>Available Colors</label>
                                <select id="transferColor" required>
                                    <option value="">Select shoe first</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Available Sizes</label>
                                <select id="transferSize" required>
                                    <option value="">Select color first</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantity (Pairs)</label>
                                <input type="number" id="transferQty" min="1" required>
                            </div>
                        </div>
                    </div>

                    <button type="submit" style="margin-top: 20px;">Record Transfer</button>
                </form>
            </div>

            <h2 style="margin-bottom: 15px;">Transfer History</h2>
            <div id="transfersList" class="sales-list"></div>
        </div>

        <!-- REPORT TAB -->
        <div id="report" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 20px;">Filter Reports</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px;">
                    <div class="form-group">
                        <label>From Date</label>
                        <input type="date" id="reportFromDate">
                    </div>
                    <div class="form-group">
                        <label>To Date</label>
                        <input type="date" id="reportToDate">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button onclick="generateReport()">Generate Report</button>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button onclick="downloadReport()" class="btn-secondary">Download Report</button>
                    </div>
                </div>
            </div>

            <div id="reportContent"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Inventory Item</h2>
                <button class="close-btn" onclick="closeEditModal()">âœ•</button>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label>Inventory Date</label>
                    <input type="date" id="editInvDate" required>
                </div>
                <div class="form-group">
                    <label>Shoe Name</label>
                    <input type="text" id="editShoeName" required>
                </div>
                <div class="form-group">
                    <label>ATNO</label>
                    <input type="text" id="editAtno">
                </div>
                <div class="form-group">
                    <label>Supplier Name</label>
                    <input type="text" id="editSupplierName">
                </div>
                <div class="form-group">
                    <label>Cost per Pair</label>
                    <input type="number" id="editCostPerPair" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Inventory (by Color)</label>
                    <div class="bulk-entry">
                        <div id="editColorGroups"></div>
                        <button type="button" onclick="addEditColorGroup()" class="btn-secondary">+ Add Color</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" style="flex: 1;">Update Item</button>
                    <button type="button" onclick="closeEditModal()" class="btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let selectedShoeId = null;
        let transferSelectedShoeId = null;
        let editingShoeId = null;

        // Initialize dates
        document.getElementById('invDate').valueAsDate = new Date();
        document.getElementById('saleDate').valueAsDate = new Date();
        document.getElementById('transferDate').valueAsDate = new Date();

        // Add initial color group
        addColorGroup();

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'inventory') loadInventory();
            if (tabName === 'sales') loadSales();
            if (tabName === 'transfers') loadTransfers();
            if (tabName === 'report') generateReport();
        }

        function addColorGroup() {
            const container = document.getElementById('colorGroups');
            const groupDiv = document.createElement('div');
            groupDiv.className = 'color-group';
            groupDiv.innerHTML = `
                <div class="color-header">
                    <input type="text" placeholder="Color name" class="color-input" style="flex: 1;">
                    <button type="button" onclick="this.closest('.color-group').remove()" class="btn-danger">Remove Color</button>
                </div>
                <div class="sizes-container"></div>
                <button type="button" onclick="addSizeToGroup(this)" class="btn-secondary" style="width: 100%; margin-top: 10px;">+ Add Size</button>
            `;
            container.appendChild(groupDiv);
            addSizeToGroup(groupDiv.querySelector('button'));
        }

        function addSizeToGroup(btn) {
            const group = btn.closest('.color-group');
            const container = group.querySelector('.sizes-container');
            const sizeRow = document.createElement('div');
            sizeRow.className = 'size-row';
            sizeRow.innerHTML = `
                <input type="text" placeholder="Size" class="size-input">
                <input type="number" placeholder="Quantity" min="1" class="qty-input">
                <button type="button" onclick="this.parentElement.remove()" class="btn-danger">Remove</button>
            `;
            container.appendChild(sizeRow);
        }

        function addEditColorGroup() {
            const container = document.getElementById('editColorGroups');
            const groupDiv = document.createElement('div');
            groupDiv.className = 'color-group';
            groupDiv.innerHTML = `
                <div class="color-header">
                    <input type="text" placeholder="Color name" class="color-input" style="flex: 1;">
                    <button type="button" onclick="this.closest('.color-group').remove()" class="btn-danger">Remove Color</button>
                </div>
                <div class="sizes-container"></div>
                <button type="button" onclick="addEditSizeToGroup(this)" class="btn-secondary" style="width: 100%; margin-top: 10px;">+ Add Size</button>
            `;
            container.appendChild(groupDiv);
            addEditSizeToGroup(groupDiv.querySelector('button'));
        }

        function addEditSizeToGroup(btn) {
            const group = btn.closest('.color-group');
            const container = group.querySelector('.sizes-container');
            const sizeRow = document.createElement('div');
            sizeRow.className = 'size-row';
            sizeRow.innerHTML = `
                <input type="text" placeholder="Size" class="size-input">
                <input type="number" placeholder="Quantity" min="1" class="qty-input">
                <button type="button" onclick="this.parentElement.remove()" class="btn-danger">Remove</button>
            `;
            container.appendChild(sizeRow);
        }

        // INVENTORY FORM
        document.getElementById('inventoryForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const invDate = document.getElementById('invDate').value;
            const shoeName = document.getElementById('shoeName').value;
            const atno = document.getElementById('atno').value || 'N/A';
            const supplierName = document.getElementById('supplierName').value || 'N/A';
            const costPerPair = parseFloat(document.getElementById('costPerPair').value) || 0;

            const colorGroups = document.querySelectorAll('#colorGroups .color-group');
            const inventory = [];

            colorGroups.forEach(group => {
                const color = group.querySelector('.color-input').value.trim();
                if (!color) return;

                const sizeRows = group.querySelectorAll('.size-row');
                sizeRows.forEach(row => {
                    const size = row.querySelector('.size-input').value.trim();
                    const qty = parseInt(row.querySelector('.qty-input').value);
                    if (size && qty) {
                        inventory.push({ color, size, qty });
                    }
                });
            });

            if (inventory.length === 0) {
                alert('Please add at least one color with size and quantity');
                return;
            }

            const shoe = {
                id: Date.now().toString(),
                date: invDate,
                name: shoeName,
                atno: atno,
                supplier: supplierName,
                cost: costPerPair,
                inventory: inventory
            };

            saveShoe(shoe);
            this.reset();
            document.getElementById('invDate').valueAsDate = new Date();
            document.getElementById('atno').value = 'N/A';
            document.getElementById('colorGroups').innerHTML = '';
            addColorGroup();
            loadInventory();
            alert('Inventory added successfully!');
        });

        function saveShoe(shoe) {
            const shoes = getShoes();
            shoes.push(shoe);
            localStorage.setItem('shoes', JSON.stringify(shoes));
        }

        function getShoes() {
            return JSON.parse(localStorage.getItem('shoes') || '[]');
        }

        function loadInventory() {
            const shoes = getShoes();
            const container = document.getElementById('inventoryList');
            
            if (shoes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3;">No inventory items yet</p>';
                return;
            }

            container.innerHTML = shoes.map(shoe => {
                const totalPairs = shoe.inventory.reduce((sum, inv) => sum + inv.qty, 0);
                const colors = [...new Set(shoe.inventory.map(inv => inv.color))];
                
                return `
                    <div class="shoe-card">
                        <h3>${shoe.name}</h3>
                        <div class="shoe-detail"><strong>ATNO:</strong> ${shoe.atno}</div>
                        <div class="shoe-detail"><strong>Date Added:</strong> ${shoe.date}</div>
                        <div class="shoe-detail"><strong>Supplier:</strong> ${shoe.supplier || 'N/A'}</div>
                        <div class="shoe-detail"><strong>Cost:</strong> KSh ${(shoe.cost || 0).toFixed(2)}</div>
                        <div class="shoe-detail"><strong>Total Pairs:</strong> ${totalPairs}</div>
                        <div class="shoe-detail">
                            <strong>Colors:</strong><br>
                            ${colors.map(c => `<span class="color-badge">${c}</span>`).join('')}
                        </div>
                        <div class="shoe-detail">
                            <strong>Inventory:</strong><br>
                            ${shoe.inventory.map(inv => `${inv.color} - Size ${inv.size}: ${inv.qty} pairs`).join('<br>')}
                        </div>
                        <div class="card-actions">
                            <button onclick="editShoe('${shoe.id}')" class="btn-secondary">Edit</button>
                            <button onclick="deleteShoe('${shoe.id}')" class="btn-danger">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteShoe(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            const shoes = getShoes().filter(s => s.id !== id);
            localStorage.setItem('shoes', JSON.stringify(shoes));
            loadInventory();
        }

        function editShoe(id) {
            const shoe = getShoes().find(s => s.id === id);
            if (!shoe) return;

            editingShoeId = id;
            
            document.getElementById('editInvDate').value = shoe.date;
            document.getElementById('editShoeName').value = shoe.name;
            document.getElementById('editAtno').value = shoe.atno;
            document.getElementById('editSupplierName').value = shoe.supplier || '';
            document.getElementById('editCostPerPair').value = shoe.cost || 0;

            document.getElementById('editColorGroups').innerHTML = '';
            
            const colorMap = {};
            shoe.inventory.forEach(inv => {
                if (!colorMap[inv.color]) {
                    colorMap[inv.color] = [];}
                colorMap[inv.color].push({ size: inv.size, qty: inv.qty });
            });

            Object.keys(colorMap).forEach(color => {
                addEditColorGroup();
                const colorGroups = document.querySelectorAll('#editColorGroups .color-group');
                const lastGroup = colorGroups[colorGroups.length - 1];
                lastGroup.querySelector('.color-input').value = color;
                
                lastGroup.querySelector('.sizes-container').innerHTML = '';
                colorMap[color].forEach(sizeInfo => {
                    addEditSizeToGroup(lastGroup.querySelector('button'));
                    const sizeRows = lastGroup.querySelectorAll('.size-row');
                    const lastRow = sizeRows[sizeRows.length - 1];
                    lastRow.querySelector('.size-input').value = sizeInfo.size;
                    lastRow.querySelector('.qty-input').value = sizeInfo.qty;
                });
            });

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingShoeId = null;
        }

        // EDIT FORM SUBMIT
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const invDate = document.getElementById('editInvDate').value;
            const shoeName = document.getElementById('editShoeName').value;
            const atno = document.getElementById('editAtno').value || 'N/A';
            const supplierName = document.getElementById('editSupplierName').value || 'N/A';
            const costPerPair = parseFloat(document.getElementById('editCostPerPair').value) || 0;

            const colorGroups = document.querySelectorAll('#editColorGroups .color-group');
            const inventory = [];

            colorGroups.forEach(group => {
                const color = group.querySelector('.color-input').value.trim();
                if (!color) return;

                const sizeRows = group.querySelectorAll('.size-row');
                sizeRows.forEach(row => {
                    const size = row.querySelector('.size-input').value.trim();
                    const qty = parseInt(row.querySelector('.qty-input').value);
                    if (size && qty) {
                        inventory.push({ color, size, qty });
                    }
                });
            });

            if (inventory.length === 0) {
                alert('Please add at least one color with size and quantity');
                return;
            }

            const shoes = getShoes();
            const shoeIndex = shoes.findIndex(s => s.id === editingShoeId);
            
            if (shoeIndex !== -1) {
                shoes[shoeIndex] = {
                    id: editingShoeId,
                    date: invDate,
                    name: shoeName,
                    atno: atno,
                    supplier: supplierName,
                    cost: costPerPair,
                    inventory: inventory
                };
                localStorage.setItem('shoes', JSON.stringify(shoes));
                closeEditModal();
                loadInventory();
                alert('Inventory updated successfully!');
            }
        });

        // SALES SEARCH
        document.getElementById('shoeSearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('searchResults');

            if (query.length < 2) {
                results.style.display = 'none';
                return;
            }

            const shoes = getShoes().filter(s => s.name.toLowerCase().includes(query));
            
            if (shoes.length === 0) {
                results.innerHTML = '<div class="search-result-item">No shoes found</div>';
                results.style.display = 'block';
                return;
            }

            results.innerHTML = shoes.map(shoe => `
                <div class="search-result-item" onclick="selectShoe('${shoe.id}')">
                    <strong>${shoe.name}</strong> (${shoe.atno})<br>
                    <small style="color: #a8a6a3;">${shoe.inventory.length} variants available</small>
                </div>
            `).join('');
            results.style.display = 'block';
        });

        function selectShoe(id) {
            const shoe = getShoes().find(s => s.id === id);
            if (!shoe) return;

            selectedShoeId = id;
            document.getElementById('selectedShoe').value = `${shoe.name} (${shoe.atno})`;
            document.getElementById('shoeSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';

            const colors = [...new Set(shoe.inventory.map(inv => inv.color))];
            const colorSelect = document.getElementById('saleColor');
            colorSelect.innerHTML = '<option value="">Select color</option>' + 
                colors.map(c => `<option value="${c}">${c}</option>`).join('');
            
            document.getElementById('saleSize').innerHTML = '<option value="">Select color first</option>';
        }

        document.getElementById('saleColor').addEventListener('change', function(e) {
            const color = e.target.value;
            if (!selectedShoeId || !color) return;

            const shoe = getShoes().find(s => s.id === selectedShoeId);
            const sizes = shoe.inventory.filter(inv => inv.color === color);
            
            const sizeSelect = document.getElementById('saleSize');
            sizeSelect.innerHTML = '<option value="">Select size</option>' +
                sizes.map(s => `<option value="${s.size}">Size ${s.size} (${s.qty} available)</option>`).join('');
        });

        // Payment calculation
        document.getElementById('salePrice').addEventListener('input', calculateTotal);
        document.getElementById('saleQty').addEventListener('input', calculateTotal);
        document.getElementById('mpesaAmount').addEventListener('input', calculateTotal);
        document.getElementById('cashAmount').addEventListener('input', calculateTotal);

        function calculateTotal() {
            const price = parseFloat(document.getElementById('salePrice').value) || 0;
            const qty = parseInt(document.getElementById('saleQty').value) || 0;
            const total = price * qty;
            document.getElementById('totalAmount').textContent = total.toFixed(2);
        }

        // SALES FORM
        document.getElementById('salesForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!selectedShoeId) {
                alert('Please select a shoe');
                return;
            }

            const saleDate = document.getElementById('saleDate').value;
            const color = document.getElementById('saleColor').value;
            const size = document.getElementById('saleSize').value;
            const qty = parseInt(document.getElementById('saleQty').value);
            const price = parseFloat(document.getElementById('salePrice').value);
            const mpesa = parseFloat(document.getElementById('mpesaAmount').value) || 0;
            const cash = parseFloat(document.getElementById('cashAmount').value) || 0;
            const customerName = document.getElementById('customerName').value.trim();
            const total = price * qty;

            if (mpesa + cash !== total) {
                alert(`Payment amounts (${(mpesa + cash).toFixed(2)}) don't match total (${total.toFixed(2)})`);
                return;
            }

            // Check inventory
            const shoes = getShoes();
            const shoe = shoes.find(s => s.id === selectedShoeId);
            const invItem = shoe.inventory.find(i => i.color === color && i.size === size);

            if (!invItem || invItem.qty < qty) {
                alert('Insufficient inventory');
                return;
            }

            // Update inventory
            invItem.qty -= qty;
            localStorage.setItem('shoes', JSON.stringify(shoes));

            // Save sale
            const sale = {
                id: Date.now().toString(),
                date: saleDate,
                shoeId: selectedShoeId,
                shoeName: shoe.name,
                color: color,
                size: size,
                qty: qty,
                pricePerPair: price,
                total: total,
                mpesa: mpesa,
                cash: cash,
                customerName: customerName || 'N/A'
            };

            const sales = getSales();
            sales.push(sale);
            localStorage.setItem('sales', JSON.stringify(sales));

            alert('Sale recorded successfully!');
            this.reset();
            selectedShoeId = null;
            document.getElementById('saleDate').valueAsDate = new Date();
            document.getElementById('saleColor').innerHTML = '<option value="">Select shoe first</option>';
            document.getElementById('saleSize').innerHTML = '<option value="">Select color first</option>';
            document.getElementById('totalAmount').textContent = '0.00';
            loadSales();
        });

        function getSales() {
            return JSON.parse(localStorage.getItem('sales') || '[]');
        }

        function loadSales() {
            const sales = getSales().sort((a, b) => new Date(b.date) - new Date(a.date));
            const container = document.getElementById('salesList');

            if (sales.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3;">No sales recorded yet</p>';
                return;
            }

            container.innerHTML = sales.slice(0, 20).map(sale => `
                <div class="sale-item">
                    <div class="sale-header">
                        <span>${sale.shoeName}</span>
                        <span>KSh ${sale.total.toFixed(2)}</span>
                    </div>
                    <div class="sale-details">
                        <strong>Date:</strong> ${sale.date}<br>
                        <strong>Customer:</strong> ${sale.customerName}<br>
                        <strong>Details:</strong> ${sale.color} - Size ${sale.size} - ${sale.qty} pair(s) @ KSh ${sale.pricePerPair.toFixed(2)}<br>
                        <strong>Payment:</strong> M-Pesa: KSh ${sale.mpesa.toFixed(2)} | Cash: KSh ${sale.cash.toFixed(2)}
                    </div>
                </div>
            `).join('');
        }

        // TRANSFERS SEARCH
        document.getElementById('transferShoeSearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('transferSearchResults');

            if (query.length < 2) {
                results.style.display = 'none';
                return;
            }

            const shoes = getShoes().filter(s => s.name.toLowerCase().includes(query));
            
            if (shoes.length === 0) {
                results.innerHTML = '<div class="search-result-item">No shoes found</div>';
                results.style.display = 'block';
                return;
            }

            results.innerHTML = shoes.map(shoe => `
                <div class="search-result-item" onclick="selectTransferShoe('${shoe.id}')">
                    <strong>${shoe.name}</strong> (${shoe.atno})<br>
                    <small style="color: #a8a6a3;">${shoe.inventory.length} variants available</small>
                </div>
            `).join('');
            results.style.display = 'block';
        });

        function selectTransferShoe(id) {
            const shoe = getShoes().find(s => s.id === id);
            if (!shoe) return;

            transferSelectedShoeId = id;
            document.getElementById('transferSelectedShoe').value = `${shoe.name} (${shoe.atno})`;
            document.getElementById('transferShoeSearch').value = '';
            document.getElementById('transferSearchResults').style.display = 'none';

            const colors = [...new Set(shoe.inventory.map(inv => inv.color))];
            const colorSelect = document.getElementById('transferColor');
            colorSelect.innerHTML = '<option value="">Select color</option>' + 
                colors.map(c => `<option value="${c}">${c}</option>`).join('');
            
            document.getElementById('transferSize').innerHTML = '<option value="">Select color first</option>';
        }

        document.getElementById('transferColor').addEventListener('change', function(e) {
            const color = e.target.value;
            if (!transferSelectedShoeId || !color) return;

            const shoe = getShoes().find(s => s.id === transferSelectedShoeId);
            const sizes = shoe.inventory.filter(inv => inv.color === color);
            
            const sizeSelect = document.getElementById('transferSize');
            sizeSelect.innerHTML = '<option value="">Select size</option>' +
                sizes.map(s => `<option value="${s.size}">Size ${s.size} (${s.qty} available)</option>`).join('');
        });

        // TRANSFER FORM
        document.getElementById('transferForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!transferSelectedShoeId) {
                alert('Please select a shoe');
                return;
            }

            const transferDate = document.getElementById('transferDate').value;
            const color = document.getElementById('transferColor').value;
            const size = document.getElementById('transferSize').value;
            const qty = parseInt(document.getElementById('transferQty').value);
            const location = document.getElementById('transferLocation').value.trim();

            // Check inventory
            const shoes = getShoes();
            const shoe = shoes.find(s => s.id === transferSelectedShoeId);
            const invItem = shoe.inventory.find(i => i.color === color && i.size === size);

            if (!invItem || invItem.qty < qty) {
                alert('Insufficient inventory');
                return;
            }

            // Update inventory
            invItem.qty -= qty;
            localStorage.setItem('shoes', JSON.stringify(shoes));

            // Save transfer
            const transfer = {
                id: Date.now().toString(),
                date: transferDate,
                shoeId: transferSelectedShoeId,
                shoeName: shoe.name,
                color: color,
                size: size,
                qty: qty,
                location: location
            };

            const transfers = getTransfers();
            transfers.push(transfer);
            localStorage.setItem('transfers', JSON.stringify(transfers));

            alert('Transfer recorded successfully!');
            this.reset();
            transferSelectedShoeId = null;
            document.getElementById('transferDate').valueAsDate = new Date();
            document.getElementById('transferColor').innerHTML = '<option value="">Select shoe first</option>';
            document.getElementById('transferSize').innerHTML = '<option value="">Select color first</option>';
            loadTransfers();
        });

        function getTransfers() {
            return JSON.parse(localStorage.getItem('transfers') || '[]');
        }

        function loadTransfers() {
            const transfers = getTransfers().sort((a, b) => new Date(b.date) - new Date(a.date));
            const container = document.getElementById('transfersList');

            if (transfers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3;">No transfers recorded yet</p>';
                return;
            }

            container.innerHTML = transfers.slice(0, 20).map(transfer => `
                <div class="sale-item">
                    <div class="sale-header">
                        <span>${transfer.shoeName}</span>
                        <span>${transfer.qty} pair(s)</span>
                    </div>
                    <div class="sale-details">
                        <strong>Date:</strong> ${transfer.date}<br>
                        <strong>Location:</strong> ${transfer.location}<br>
                        <strong>Details:</strong> ${transfer.color} - Size ${transfer.size} - ${transfer.qty} pair(s)
                    </div>
                </div>
            `).join('');
        }

        // REPORTS
        function generateReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;

            let sales = getSales();
            let transfers = getTransfers();

            if (fromDate) {
                sales = sales.filter(s => s.date >= fromDate);
                transfers = transfers.filter(t => t.date >= fromDate);
            }
            if (toDate) {
                sales = sales.filter(s => s.date <= toDate);
                transfers = transfers.filter(t => t.date <= toDate);
            }

            const totalSales = sales.reduce((sum, s) => sum + s.total, 0);
            const totalMpesa = sales.reduce((sum, s) => sum + s.mpesa, 0);
            const totalCash = sales.reduce((sum, s) => sum + s.cash, 0);
            const totalPairs = sales.reduce((sum, s) => sum + s.qty, 0);
            const totalTransferPairs = transfers.reduce((sum, t) => sum + t.qty, 0);

            // Sales by date
            const salesByDate = {};
            sales.forEach(s => {
                if (!salesByDate[s.date]) {
                    salesByDate[s.date] = { total: 0, mpesa: 0, cash: 0, pairs: 0 };
                }
                salesByDate[s.date].total += s.total;
                salesByDate[s.date].mpesa += s.mpesa;
                salesByDate[s.date].cash += s.cash;
                salesByDate[s.date].pairs += s.qty;
            });

            // Transfers by location
            const transfersByLocation = {};
            transfers.forEach(t => {
                if (!transfersByLocation[t.location]) {
                    transfersByLocation[t.location] = { pairs: 0, count: 0 };
                }
                transfersByLocation[t.location].pairs += t.qty;
                transfersByLocation[t.location].count++;
            });

            const container = document.getElementById('reportContent');
            container.innerHTML = `
                <div class="report-card">
                    <h2 style="margin-bottom: 20px;">Sales Summary</h2>
                    <div class="report-stat">
                        <span class="stat-label">Total Sales Amount</span>
                        <span class="stat-value">KSh ${totalSales.toFixed(2)}</span>
                    </div>
                    <div class="report-stat">
                        <span class="stat-label">Total M-Pesa Payments</span>
                        <span class="stat-value">KSh ${totalMpesa.toFixed(2)}</span>
                    </div>
                    <div class="report-stat">
                        <span class="stat-label">Total Cash Payments</span>
                        <span class="stat-value">KSh ${totalCash.toFixed(2)}</span>
                    </div>
                    <div class="report-stat">
                        <span class="stat-label">Total Pairs Sold</span>
                        <span class="stat-value">${totalPairs}</span>
                    </div>
                    <div class="report-stat">
                        <span class="stat-label">Number of Transactions</span>
                        <span class="stat-value">${sales.length}</span>
                    </div>
                </div>

                <div class="report-card">
                    <h2 style="margin-bottom: 20px;">Transfer Summary</h2>
                    <div class="report-stat">
                        <span class="stat-label">Total Pairs Transferred</span>
                        <span class="stat-value">${totalTransferPairs}</span>
                    </div>
                    <div class="report-stat">
                        <span class="stat-label">Total Transfers</span>
                        <span class="stat-value">${transfers.length}</span>
                    </div>
                    ${Object.keys(transfersByLocation).length > 0 ? `
                        <h3 style="margin-top: 20px; margin-bottom: 10px; color: #f5f3f0;">By Location</h3>
                        ${Object.entries(transfersByLocation).map(([location, data]) => `
                            <div class="report-stat">
                                <span class="stat-label">${location}</span>
                                <span class="stat-value">${data.pairs} pairs (${data.count} transfers)</span>
                            </div>
                        `).join('')}
                    ` : ''}
                </div>

                <div class="report-card">
                    <h2 style="margin-bottom: 20px;">Sales by Date</h2>
                    ${Object.entries(salesByDate).sort((a, b) => new Date(b[0]) - new Date(a[0])).map(([date, data]) => `
                        <div class="report-stat">
                            <span class="stat-label">${date}</span>
                            <span class="stat-value">KSh ${data.total.toFixed(2)}</span>
                        </div>
                        <div style="padding-left: 20px; font-size: 13px; color: #a8a6a3; margin-bottom: 10px;">
                            M-Pesa: KSh ${data.mpesa.toFixed(2)} | Cash: KSh ${data.cash.toFixed(2)} | ${data.pairs} pairs sold
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function downloadReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;

            let sales = getSales();
            let transfers = getTransfers();

            if (fromDate) {
                sales = sales.filter(s => s.date >= fromDate);
                transfers = transfers.filter(t => t.date >= fromDate);
            }
            if (toDate) {
                sales = sales.filter(s => s.date <= toDate);
                transfers = transfers.filter(t => t.date <= toDate);
            }

            let csvContent = 'SALES REPORT\n\n';
            csvContent += 'Date,Customer,Shoe Name,Color,Size,Quantity,Price per Pair,Total,M-Pesa,Cash\n';
            
            sales.forEach(sale => {
                csvContent += `${sale.date},${sale.customerName},${sale.shoeName},${sale.color},${sale.size},${sale.qty},${sale.pricePerPair.toFixed(2)},${sale.total.toFixed(2)},${sale.mpesa.toFixed(2)},${sale.cash.toFixed(2)}\n`;
            });

            csvContent += '\n\nTRANSFERS REPORT\n\n';
            csvContent += 'Date,Shoe Name,Color,Size,Quantity,Location\n';
            
            transfers.forEach(transfer => {
                csvContent += `${transfer.date},${transfer.shoeName},${transfer.color},${transfer.size},${transfer.qty},${transfer.location}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize
        loadInventory();
    </script>
</body>
</html>
