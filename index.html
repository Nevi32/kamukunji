<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shoe Inventory System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-bg: #0f0f0f;
            --secondary-bg: #1a1a1a;
            --card-bg: #252525;
            --border-color: #333;
            --accent-color: #fff;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --text-muted: #737373;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --radius: 12px;
            --radius-sm: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
            font-size: 16px;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 16px;
        }

        h1 {
            text-align: center;
            margin: 20px 0;
            color: var(--accent-color);
            font-size: clamp(1.5rem, 5vw, 2rem);
            font-weight: 700;
        }

        h2 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            color: var(--accent-color);
            font-weight: 600;
        }

        h3 {
            font-size: 1.1rem;
            margin-bottom: 12px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 4px;
            position: sticky;
            top: 0;
            background: var(--primary-bg);
            z-index: 100;
            padding-top: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 16px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            font-size: 0.9rem;
            user-select: none;
        }

        .tab:hover {
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent-color);
            color: #000;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-card, .search-card, .info-banner {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .info-banner {
            background: var(--secondary-bg);
            border-left: 4px solid var(--accent-color);
        }

        .info-banner p {
            margin: 4px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
        }

        button {
            width: 100%;
            padding: 14px;
            background: var(--accent-color);
            color: #000;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            margin-top: 8px;
            touch-action: manipulation;
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #444;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: #000;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.85rem;
            margin-top: 0;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        @media (min-width: 640px) {
            .search-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .search-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .search-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        @media (min-width: 640px) {
            .inventory-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .inventory-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .shoe-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }

        .shoe-card:hover {
            transform: translateY(-2px);
            border-color: #444;
        }

        .shoe-card h3 {
            color: var(--accent-color);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .shoe-detail {
            margin: 4px 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .shoe-detail strong {
            color: var(--text-primary);
        }

        .card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .color-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--secondary-bg);
            border-radius: 12px;
            margin: 2px 4px 2px 0;
            font-size: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .cart-container {
            background: var(--secondary-bg);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            min-height: 100px;
            border: 1px solid var(--border-color);
        }

        .cart-item {
            background: var(--card-bg);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            display: grid;
            gap: 8px;
        }

        .cart-item-header {
            font-weight: 600;
            color: var(--accent-color);
            font-size: 1rem;
        }

        .cart-item-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .cart-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .cart-item input {
            width: 80px;
            padding: 6px;
            text-align: center;
        }

        .sales-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sale-item {
            background: var(--card-bg);
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }

        .sale-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .sale-header strong {
            color: var(--accent-color);
            font-size: 1.1rem;
        }

        .sale-details {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .sale-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: var(--card-bg);
            min-height: 100vh;
            padding: 20px;
        }

        @media (min-width: 640px) {
            .modal-content {
                min-height: auto;
                max-width: 600px;
                margin: 40px auto;
                border-radius: var(--radius);
                border: 1px solid var(--border-color);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
        }

        .close-btn {
            background: var(--danger-color);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            margin: 0;
        }

        .variant-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        @media (min-width: 480px) {
            .variant-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .variant-card {
            background: var(--secondary-bg);
            padding: 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .variant-card:hover {
            border-color: var(--accent-color);
            background: #2a2a2a;
        }

        .variant-title {
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 4px;
        }

        .variant-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .toolbar button {
            flex: 1;
            min-width: 140px;
            margin: 0;
        }

        @media (min-width: 640px) {
            .toolbar {
                flex-wrap: nowrap;
            }
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .mb-2 {
            margin-bottom: 8px;
        }

        .mt-2 {
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: var(--radius);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--accent-color);
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .color-group {
            background: var(--secondary-bg);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }

        .size-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 8px;
            margin-bottom: 8px;
            align-items: end;
        }

        @media (max-width: 480px) {
            .size-row {
                grid-template-columns: 1fr;
            }
        }

        /* New Sales UI Styles */
        .size-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .size-box {
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            user-select: none;
        }

        .size-box:hover:not(.disabled) {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .size-box.selected {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: #000;
        }

        .size-box.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #1a1a1a;
        }

        .size-box .size-label {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .size-box .stock-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .size-box.selected .stock-label {
            color: #000;
            opacity: 0.7;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 24px;
            padding: 16px;
            background: var(--secondary-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        .qty-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin: 0;
            padding: 0;
        }

        .qty-btn:hover:not(:disabled) {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: #000;
        }

        .qty-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .qty-display {
            font-size: 2rem;
            font-weight: 700;
            min-width: 80px;
            text-align: center;
            color: var(--accent-color);
        }

        .stock-info {
            text-align: center;
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .stock-info .available {
            color: var(--success-color);
            font-weight: 600;
        }

        .stock-info .low {
            color: var(--warning-color);
            font-weight: 600;
        }

        .stock-info .out {
            color: var(--danger-color);
            font-weight: 600;
        }

        .selected-sizes-preview {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .selected-size-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--secondary-bg);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }

        .selected-size-info {
            flex: 1;
        }

        .selected-size-name {
            font-weight: 600;
            color: var(--accent-color);
        }

        .selected-size-qty {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .remove-size-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--danger-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
        }

        .price-input-group {
            margin: 20px 0;
        }

        .validation-message {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 8px;
            text-align: center;
            min-height: 20px;
        }

        .cart-item-sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .cart-size-tag {
            background: var(--secondary-bg);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
        }

        .shoe-search-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 16px;
        }

        .shoe-search-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .color-section {
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .color-header {
            background: var(--secondary-bg);
            padding: 12px 16px;
            font-weight: 600;
            color: var(--accent-color);
            border-bottom: 1px solid var(--border-color);
        }

        .color-content {
            padding: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëü Shoe Inventory</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('inventory')">üì¶ Inventory</div>
            <div class="tab" onclick="switchTab('sales')">üí∞ Sales</div>
            <div class="tab" onclick="switchTab('transfers')">üöö Transfers</div>
            <div class="tab" onclick="switchTab('report')">üìä Reports</div>
        </div>

        <div id="inventory" class="tab-content active">
            <div class="form-card">
                <h2>Add New Item</h2>
                <form id="inventoryForm">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="invDate" required>
                    </div>
                    <div class="form-group">
                        <label>Shoe Name</label>
                        <input type="text" id="shoeName" placeholder="e.g., Nike Air Max" required>
                    </div>
                    <div class="form-group">
                        <label>ATNO (Article Number)</label>
                        <input type="text" id="atno" value="N/A">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="supplierName" placeholder="Supplier name">
                    </div>
                    <div class="form-group">
                        <label>Cost per Pair (KSh)</label>
                        <input type="number" id="costPerPair" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Colors & Sizes</label>
                        <div id="colorGroups"></div>
                        <button type="button" onclick="addColorGroup()" class="btn-secondary">+ Add Color</button>
                    </div>
                    <button type="submit">Save to Inventory</button>
                </form>
            </div>

            <div class="search-card">
                <h3>üîç Search Inventory</h3>
                <div class="search-grid">
                    <input type="text" id="searchName" placeholder="Shoe name">
                    <input type="text" id="searchAtno" placeholder="ATNO">
                    <input type="text" id="searchColor" placeholder="Color">
                    <input type="text" id="searchSize" placeholder="Size">
                </div>
                <div class="search-actions">
                    <button onclick="clearSearch()" class="btn-secondary">Clear</button>
                    <button onclick="performAdvancedSearch()" class="btn-success">Search</button>
                </div>
            </div>

            <div class="info-banner">
                <p><strong>Storage:</strong> <span id="storageInfo">Firebase Cloud</span></p>
                <p>Backup your data regularly using the download button below.</p>
            </div>

            <div class="toolbar">
                <button onclick="downloadInventoryCSV()" class="btn-secondary">üì• Download CSV</button>
            </div>

            <h2>Current Stock</h2>
            <div id="inventoryList" class="inventory-grid"></div>
        </div>

        <div id="sales" class="tab-content">
            <div class="search-card">
                <h3>üîç Search Sales</h3>
                <div class="search-grid">
                    <input type="text" id="searchSaleCustomer" placeholder="Customer name">
                    <input type="text" id="searchSaleShoe" placeholder="Shoe name">
                    <input type="date" id="searchSaleFromDate" placeholder="From date">
                    <input type="date" id="searchSaleToDate" placeholder="To date">
                </div>
                <div class="search-actions">
                    <button onclick="clearSaleSearch()" class="btn-secondary">Clear</button>
                    <button onclick="performSaleSearch()" class="btn-success">Search</button>
                </div>
            </div>

            <div class="form-card">
                <h2>New Sale</h2>
                <form id="salesForm">
                    <div class="form-group">
                        <label>Sale Date</label>
                        <input type="date" id="saleDate" required>
                    </div>
                    <div class="form-group">
                        <label>Customer (Optional)</label>
                        <input type="text" id="customerName" placeholder="Walk-in Customer">
                    </div>
                    
                    <button type="button" class="btn-success" onclick="openShoeSelectionModal()" style="margin-bottom: 16px;">
                        + Add Items to Sale
                    </button>

                    <div class="form-group">
                        <label>Items in Cart</label>
                        <div id="saleItemsCart" class="cart-container">
                            <p class="text-center text-muted" style="padding: 20px;">Cart is empty</p>
                        </div>
                    </div>

                    <div style="background: var(--secondary-bg); padding: 16px; border-radius: var(--radius-sm); margin-bottom: 16px;">
                        <div class="form-group">
                            <label>M-Pesa Amount (KSh)</label>
                            <input type="number" id="mpesaAmount" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Cash Amount (KSh)</label>
                            <input type="number" id="cashAmount" min="0" step="0.01" value="0">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                            <span style="font-size: 1.1rem; font-weight: 600;">Total:</span>
                            <span id="grandTotal" style="font-size: 1.3rem; font-weight: 700; color: var(--success-color);">KSh 0.00</span>
                        </div>
                        <div style="text-align: center; margin-top: 8px;">
                            <span id="paymentStatus" style="color: var(--danger-color); font-weight: 600; font-size: 0.9rem;">UNBALANCED</span>
                        </div>
                    </div>

                    <button type="submit" id="completeSaleBtn" disabled>Complete Sale</button>
                </form>
            </div>

            <div class="toolbar">
                <button onclick="downloadSalesCSV()" class="btn-secondary">üì• Download Sales</button>
            </div>

            <h2>Recent Sales</h2>
            <div id="salesList" class="sales-list"></div>
        </div>

        <div id="transfers" class="tab-content">
            <div class="form-card">
                <h2>New Transfer</h2>
                <form id="transferForm">
                    <div class="form-group">
                        <label>Transfer Date</label>
                        <input type="date" id="transferDate" required>
                    </div>
                    <div class="form-group">
                        <label>Destination</label>
                        <input type="text" id="transferLocation" placeholder="e.g., Downtown Store" required>
                    </div>
                    
                    <button type="button" class="btn-success" onclick="openTransferSelectionModal()" style="margin-bottom: 16px;">
                        + Add Items to Transfer
                    </button>

                    <div class="form-group">
                        <label>Items to Transfer</label>
                        <div id="transferItemsCart" class="cart-container">
                            <p class="text-center text-muted" style="padding: 20px;">No items added</p>
                        </div>
                    </div>

                    <button type="submit" id="completeTransferBtn" disabled>Complete Transfer</button>
                </form>
            </div>

            <div class="toolbar">
                <button onclick="downloadTransfersCSV()" class="btn-secondary">üì• Download Transfers</button>
            </div>

            <h2>Transfer History</h2>
            <div id="transfersList" class="sales-list"></div>
        </div>

        <div id="report" class="tab-content">
            <div class="form-card">
                <h2>Generate Report</h2>
                <div class="search-grid">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>From Date</label>
                        <input type="date" id="reportFromDate">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>To Date</label>
                        <input type="date" id="reportToDate">
                    </div>
                </div>
                <div class="toolbar" style="margin-top: 16px; margin-bottom: 0;">
                    <button onclick="generateReport()">Generate</button>
                    <button onclick="downloadReport()" class="btn-secondary">Download</button>
                </div>
            </div>

            <div id="reportContent"></div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Item</h2>
                <button class="close-btn" onclick="closeEditModal()">‚úï</button>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="editInvDate" required>
                </div>
                <div class="form-group">
                    <label>Shoe Name</label>
                    <input type="text" id="editShoeName" required>
                </div>
                <div class="form-group">
                    <label>ATNO</label>
                    <input type="text" id="editAtno">
                </div>
                <div class="form-group">
                    <label>Supplier</label>
                    <input type="text" id="editSupplierName">
                </div>
                <div class="form-group">
                    <label>Cost per Pair</label>
                    <input type="number" id="editCostPerPair" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Inventory</label>
                    <div id="editColorGroups"></div>
                    <button type="button" onclick="addEditColorGroup()" class="btn-secondary">+ Add Color</button>
                </div>
                <button type="submit">Update Item</button>
            </form>
        </div>
    </div>

    <!-- New Improved Shoe Selection Modal -->
    <div id="shoeSelectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Shoe</h2>
                <button class="close-btn" onclick="closeShoeSelectionModal()">‚úï</button>
            </div>
            <input type="text" id="shoeSelectionSearch" class="shoe-search-input" placeholder="Search shoes by name, ATNO, color...">
            <div id="shoeSelectionResults" class="variant-grid"></div>
        </div>
    </div>

    <!-- New Improved Size Selection Modal -->
    <div id="sizeSelectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="sizeModalTitle">Select Sizes</h2>
                <button class="close-btn" onclick="closeSizeSelectionModal()">‚úï</button>
            </div>
            
            <div id="sizeSelectionContent">
                <!-- Dynamic content loaded here -->
            </div>

            <div class="price-input-group">
                <label>Selling Price per Pair (KSh)</label>
                <input type="number" id="sizeModalPrice" placeholder="Enter price" min="0" step="0.01">
            </div>

            <div id="validationMessage" class="validation-message"></div>

            <button onclick="confirmSizeSelection()" class="btn-success" id="confirmSizeBtn" disabled>
                Add to Sale
            </button>
        </div>
    </div>

    <div id="transferSelectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select for Transfer</h2>
                <button class="close-btn" onclick="closeTransferSelectionModal()">‚úï</button>
            </div>
            <input type="text" id="transferSelectionSearch" placeholder="Search shoes..." style="margin-bottom: 16px;">
            <div id="transferSelectionResults" class="variant-grid"></div>
        </div>
    </div>

    <div id="editSaleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Sale</h2>
                <button class="close-btn" onclick="closeEditSaleModal()">‚úï</button>
            </div>
            <form id="editSaleForm">
                <div class="form-group">
                    <label>Sale Date</label>
                    <input type="date" id="editSaleDate" required>
                </div>
                <div class="form-group">
                    <label>Customer</label>
                    <input type="text" id="editCustomerName">
                </div>
                <div class="form-group">
                    <label>Items</label>
                    <div id="editSaleItemsCart" class="cart-container"></div>
                </div>
                <div style="background: var(--secondary-bg); padding: 16px; border-radius: var(--radius-sm); margin-bottom: 16px;">
                    <div class="form-group">
                        <label>M-Pesa</label>
                        <input type="number" id="editMpesaAmount" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Cash</label>
                        <input type="number" id="editCashAmount" min="0" step="0.01">
                    </div>
                    <div style="text-align: right; margin-top: 8px;">
                        <strong>Total: <span id="editGrandTotal" style="color: var(--success-color);">KSh 0.00</span></strong>
                    </div>
                </div>
                <button type="submit">Update Sale</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js ";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js ";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            updateDoc, 
            deleteDoc, 
            doc,
            query,
            where,
            orderBy
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js ";

        const firebaseConfig = {
            apiKey: "AIzaSyBKqd_AGJcPaTbb8y-pMiNUoGkFkQqqXXU",
            authDomain: "essential-truth-403610.firebaseapp.com",
            projectId: "essential-truth-403610",
            storageBucket: "essential-truth-403610.firebasestorage.app",
            messagingSenderId: "931489894045",
            appId: "1:931489894045:web:e3ef0eb7a1ee4ae9328e74",
            measurementId: "G-83GL74BQG7"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.firebaseReady = true;
        
        if (typeof initializeAppData === 'function') {
            initializeAppData();
        }
    </script>

    <script>
        let editingShoeId = null;
        let currentSaleItems = [];
        let editingSaleId = null;
        let saleItemsForEdit = [];
        let currentTransferItems = [];
        let currentShoeSelection = null;
        let tempSelectedSizes = [];
        let allSalesData = [];
        
        let cachedShoesForSelection = [];

        const COLLECTIONS = { SHOES: 'shoes', SALES: 'sales', TRANSFERS: 'transfers' };

        function initializeAppData() {
            document.getElementById('invDate').valueAsDate = new Date();
            document.getElementById('saleDate').valueAsDate = new Date();
            document.getElementById('transferDate').valueAsDate = new Date();
            addColorGroup();
            loadInventory();
            loadSales();
            
            setupModalSearchListeners();
        }

        if (window.firebaseReady) initializeAppData();

        function setupModalSearchListeners() {
            const shoeSearch = document.getElementById('shoeSelectionSearch');
            shoeSearch.addEventListener('input', (e) => {
                filterShoeSelection(e.target.value);
            });
            
            const transferSearch = document.getElementById('transferSelectionSearch');
            transferSearch.addEventListener('input', (e) => {
                filterTransferSelection(e.target.value);
            });
        }

        async function getShoes() {
            try {
                const snapshot = await getDocs(collection(db, COLLECTIONS.SHOES));
                const shoes = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    delete data.id;
                    shoes.push({ id: doc.id, ...data });
                });
                return shoes;
            } catch (e) {
                alert('Error loading inventory: ' + e.message);
                return [];
            }
        }

        async function saveShoe(shoe) {
            try { await addDoc(collection(db, COLLECTIONS.SHOES), shoe); return true; }
            catch (e) { alert('Error saving: ' + e.message); return false; }
        }

        async function updateShoe(id, data) {
            try { await updateDoc(doc(db, COLLECTIONS.SHOES, id), data); return true; }
            catch (e) { alert('Error updating: ' + e.message); return false; }
        }

        async function deleteShoeFromStorage(id) {
            try { await deleteDoc(doc(db, COLLECTIONS.SHOES, id)); return true; }
            catch (e) { alert('Error deleting: ' + e.message); return false; }
        }

        async function getSales() {
            try {
                const snapshot = await getDocs(collection(db, COLLECTIONS.SALES));
                const sales = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!data.items && data.shoeId) {
                        data.items = [{
                            id: doc.id + '_item',
                            shoeId: data.shoeId,
                            shoeName: data.shoeName,
                            atno: data.atno || 'N/A',
                            color: data.color,
                            size: data.size,
                            qty: data.qty,
                            pricePerPair: data.pricePerPair,
                            total: data.total
                        }];
                    }
                    sales.push({ id: doc.id, ...data });
                });
                return sales;
            } catch (e) {
                alert('Error loading sales: ' + e.message);
                return [];
            }
        }

        async function saveSale(sale) {
            try { await addDoc(collection(db, COLLECTIONS.SALES), sale); return true; }
            catch (e) { alert('Error saving sale: ' + e.message); return false; }
        }

        async function updateSale(id, data) {
            try { await updateDoc(doc(db, COLLECTIONS.SALES, id), data); return true; }
            catch (e) { alert('Error updating sale: ' + e.message); return false; }
        }

        async function deleteSaleFromStorage(id) {
            try { await deleteDoc(doc(db, COLLECTIONS.SALES, id)); return true; }
            catch (e) { alert('Error deleting sale: ' + e.message); return false; }
        }

        async function getTransfers() {
            try {
                const snapshot = await getDocs(collection(db, COLLECTIONS.TRANSFERS));
                const transfers = [];
                snapshot.forEach(doc => transfers.push({ id: doc.id, ...doc.data() }));
                return transfers;
            } catch (e) {
                alert('Error loading transfers: ' + e.message);
                return [];
            }
        }

        async function saveTransfer(transfer) {
            try { await addDoc(collection(db, COLLECTIONS.TRANSFERS), transfer); return true; }
            catch (e) { alert('Error saving transfer: ' + e.message); return false; }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'inventory') loadInventory();
            if (tabName === 'sales') loadSales();
            if (tabName === 'transfers') loadTransfers();
            if (tabName === 'report') generateReport();
        }

        function addColorGroup() {
            const container = document.getElementById('colorGroups');
            const div = document.createElement('div');
            div.className = 'color-group';
            div.innerHTML = `
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" placeholder="Color" class="color-input" style="flex: 1;">
                    <button type="button" onclick="this.closest('.color-group').remove()" class="btn-danger btn-small">Remove</button>
                </div>
                <div class="sizes-container"></div>
                <button type="button" onclick="addSizeToGroup(this)" class="btn-secondary btn-small">+ Size</button>
            `;
            container.appendChild(div);
            addSizeToGroup(div.querySelector('button'));
        }

        function addSizeToGroup(btn) {
            const container = btn.previousElementSibling;
            const row = document.createElement('div');
            row.className = 'size-row';
            row.innerHTML = `
                <input type="text" placeholder="Size" class="size-input">
                <input type="number" placeholder="Qty" min="1" class="qty-input">
                <button type="button" onclick="this.parentElement.remove()" class="btn-danger btn-small">Remove</button>
            `;
            container.appendChild(row);
        }

        function addEditColorGroup() {
            const container = document.getElementById('editColorGroups');
            const div = document.createElement('div');
            div.className = 'color-group';
            div.innerHTML = `
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" placeholder="Color" class="color-input" style="flex: 1;">
                    <button type="button" onclick="this.closest('.color-group').remove()" class="btn-danger btn-small">Remove</button>
                </div>
                <div class="sizes-container"></div>
                <button type="button" onclick="addEditSizeToGroup(this)" class="btn-secondary btn-small">+ Size</button>
            `;
            container.appendChild(div);
        }

        function addEditSizeToGroup(btn) {
            const container = btn.previousElementSibling;
            const row = document.createElement('div');
            row.className = 'size-row';
            row.innerHTML = `
                <input type="text" placeholder="Size" class="size-input">
                <input type="number" placeholder="Qty" min="1" class="qty-input">
                <button type="button" onclick="this.parentElement.remove()" class="btn-danger btn-small">Remove</button>
            `;
            container.appendChild(row);
        }

        document.getElementById('inventoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const shoe = {
                date: document.getElementById('invDate').value,
                name: document.getElementById('shoeName').value,
                atno: document.getElementById('atno').value || 'N/A',
                supplier: document.getElementById('supplierName').value || 'N/A',
                cost: parseFloat(document.getElementById('costPerPair').value) || 0,
                inventory: [],
                createdAt: new Date().toISOString()
            };

            document.querySelectorAll('#colorGroups .color-group').forEach(group => {
                const color = group.querySelector('.color-input').value.trim();
                if (!color) return;
                group.querySelectorAll('.size-row').forEach(row => {
                    const size = row.querySelector('.size-input').value.trim();
                    const qty = parseInt(row.querySelector('.qty-input').value);
                    if (size && qty) shoe.inventory.push({ color, size, qty });
                });
            });

            if (shoe.inventory.length === 0) {
                alert('Add at least one color/size');
                return;
            }

            if (await saveShoe(shoe)) {
                e.target.reset();
                document.getElementById('invDate').valueAsDate = new Date();
                document.getElementById('atno').value = 'N/A';
                document.getElementById('colorGroups').innerHTML = '';
                addColorGroup();
                loadInventory();
                alert('‚úÖ Saved successfully');
            }
        });

        async function loadInventory(searchParams = null) {
            let shoes = await getShoes();
            const container = document.getElementById('inventoryList');

            if (searchParams) {
                shoes = shoes.filter(shoe => {
                    if (searchParams.name && !shoe.name.toLowerCase().includes(searchParams.name.toLowerCase())) return false;
                    if (searchParams.atno && !shoe.atno.toLowerCase().includes(searchParams.atno.toLowerCase())) return false;
                    if (searchParams.supplier && !shoe.supplier.toLowerCase().includes(searchParams.supplier.toLowerCase())) return false;
                    if (searchParams.color || searchParams.size) {
                        const hasMatch = shoe.inventory.some(inv => {
                            if (searchParams.color && !inv.color.toLowerCase().includes(searchParams.color.toLowerCase())) return false;
                            if (searchParams.size && !inv.size.toLowerCase().includes(searchParams.size.toLowerCase())) return false;
                            return true;
                        });
                        if (!hasMatch) return false;
                    }
                    return true;
                });
            }

            if (shoes.length === 0) {
                container.innerHTML = '<p class="empty-state">No items found</p>';
                return;
            }

            container.innerHTML = shoes.map(shoe => {
                const total = shoe.inventory.reduce((sum, inv) => sum + inv.qty, 0);
                const colors = [...new Set(shoe.inventory.map(i => i.color))];
                return `
                    <div class="shoe-card">
                        <h3>${shoe.name}</h3>
                        <div class="shoe-detail"><strong>ATNO:</strong> ${shoe.atno}</div>
                        <div class="shoe-detail"><strong>Date:</strong> ${shoe.date}</div>
                        <div class="shoe-detail"><strong>Supplier:</strong> ${shoe.supplier}</div>
                        <div class="shoe-detail"><strong>Cost:</strong> KSh ${(shoe.cost || 0).toFixed(2)}</div>
                        <div class="shoe-detail"><strong>Stock:</strong> ${total} pairs</div>
                        <div style="margin: 8px 0;">
                            ${colors.map(c => `<span class="color-badge">${c}</span>`).join('')}
                        </div>
                        <div class="card-actions">
                            <button onclick="editShoe('${shoe.id}')" class="btn-secondary btn-small">Edit</button>
                            <button onclick="deleteShoe('${shoe.id}')" class="btn-danger btn-small">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function deleteShoe(id) {
            if (!confirm('Delete this item?')) return;
            if (await deleteShoeFromStorage(id)) {
                loadInventory();
                alert('‚úÖ Deleted');
            }
        }

        async function editShoe(id) {
            const shoes = await getShoes();
            const shoe = shoes.find(s => s.id === id);
            if (!shoe) return;

            editingShoeId = id;
            document.getElementById('editInvDate').value = shoe.date;
            document.getElementById('editShoeName').value = shoe.name;
            document.getElementById('editAtno').value = shoe.atno;
            document.getElementById('editSupplierName').value = shoe.supplier || '';
            document.getElementById('editCostPerPair').value = shoe.cost || 0;

            const container = document.getElementById('editColorGroups');
            container.innerHTML = '';
            
            const colorMap = {};
            shoe.inventory.forEach(inv => {
                if (!colorMap[inv.color]) colorMap[inv.color] = [];
                colorMap[inv.color].push(inv);
            });

            Object.entries(colorMap).forEach(([color, items]) => {
                addEditColorGroup();
                const groups = container.querySelectorAll('.color-group');
                const lastGroup = groups[groups.length - 1];
                lastGroup.querySelector('.color-input').value = color;
                lastGroup.querySelector('.sizes-container').innerHTML = '';
                
                items.forEach(item => {
                    addEditSizeToGroup(lastGroup.querySelector('button:last-child'));
                    const rows = lastGroup.querySelectorAll('.size-row');
                    const lastRow = rows[rows.length - 1];
                    lastRow.querySelector('.size-input').value = item.size;
                    lastRow.querySelector('.qty-input').value = item.qty;
                });
            });

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingShoeId = null;
        }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                date: document.getElementById('editInvDate').value,
                name: document.getElementById('editShoeName').value,
                atno: document.getElementById('editAtno').value || 'N/A',
                supplier: document.getElementById('editSupplierName').value || 'N/A',
                cost: parseFloat(document.getElementById('editCostPerPair').value) || 0,
                inventory: [],
                updatedAt: new Date().toISOString()
            };

            document.querySelectorAll('#editColorGroups .color-group').forEach(group => {
                const color = group.querySelector('.color-input').value.trim();
                if (!color) return;
                group.querySelectorAll('.size-row').forEach(row => {
                    const size = row.querySelector('.size-input').value.trim();
                    const qty = parseInt(row.querySelector('.qty-input').value);
                    if (size && qty) data.inventory.push({ color, size, qty });
                });
            });

            if (await updateShoe(editingShoeId, data)) {
                closeEditModal();
                loadInventory();
                alert('‚úÖ Updated');
            }
        });

        function performAdvancedSearch() {
            loadInventory({
                name: document.getElementById('searchName').value,
                atno: document.getElementById('searchAtno').value,
                color: document.getElementById('searchColor').value,
                size: document.getElementById('searchSize').value,
                supplier: document.getElementById('searchSupplier')?.value
            });
        }

        function clearSearch() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchAtno').value = '';
            document.getElementById('searchColor').value = '';
            document.getElementById('searchSize').value = '';
            if (document.getElementById('searchSupplier')) document.getElementById('searchSupplier').value = '';
            loadInventory();
        }

        async function performSaleSearch() {
            const customer = document.getElementById('searchSaleCustomer').value.toLowerCase();
            const shoe = document.getElementById('searchSaleShoe').value.toLowerCase();
            const fromDate = document.getElementById('searchSaleFromDate').value;
            const toDate = document.getElementById('searchSaleToDate').value;

            let sales = await getSales();
            
            const filtered = sales.filter(sale => {
                if (customer && !sale.customerName.toLowerCase().includes(customer)) return false;
                if (shoe && !sale.items.some(item => item.shoeName.toLowerCase().includes(shoe))) return false;
                if (fromDate && sale.date < fromDate) return false;
                if (toDate && sale.date > toDate) return false;
                return true;
            });

            renderSalesList(filtered);
        }

        function clearSaleSearch() {
            document.getElementById('searchSaleCustomer').value = '';
            document.getElementById('searchSaleShoe').value = '';
            document.getElementById('searchSaleFromDate').value = '';
            document.getElementById('searchSaleToDate').value = '';
            loadSales();
        }

        // New Improved Sales Functions
        function openShoeSelectionModal() {
            document.getElementById('shoeSelectionModal').classList.add('active');
            document.getElementById('shoeSelectionSearch').value = '';
            loadShoeSelection();
        }

        function closeShoeSelectionModal() {
            document.getElementById('shoeSelectionModal').classList.remove('active');
            document.getElementById('shoeSelectionSearch').value = '';
            cachedShoesForSelection = [];
        }

        async function loadShoeSelection() {
            const shoes = await getShoes();
            cachedShoesForSelection = shoes;
            renderShoeSelectionResults(shoes);
        }

        function renderShoeSelectionResults(shoes) {
            const container = document.getElementById('shoeSelectionResults');
            
            // Group by shoe, then by color
            const shoeGroups = {};
            shoes.forEach(shoe => {
                if (!shoeGroups[shoe.id]) {
                    shoeGroups[shoe.id] = {
                        ...shoe,
                        colors: {}
                    };
                }
                shoe.inventory.forEach(inv => {
                    if (inv.qty > 0) {
                        if (!shoeGroups[shoe.id].colors[inv.color]) {
                            shoeGroups[shoe.id].colors[inv.color] = [];
                        }
                        shoeGroups[shoe.id].colors[inv.color].push(inv);
                    }
                });
            });

            const validShoes = Object.values(shoeGroups).filter(s => Object.keys(s.colors).length > 0);

            if (validShoes.length === 0) {
                container.innerHTML = '<p class="empty-state">No items in stock</p>';
                return;
            }

            container.innerHTML = validShoes.map(shoe => {
                const totalStock = Object.values(shoe.colors).flat().reduce((a, b) => a + b.qty, 0);
                return `
                    <div class="variant-card" onclick="openSizeSelectionModal('${shoe.id}')">
                        <div class="variant-title">${shoe.name}</div>
                        <div class="variant-info">
                            ATNO: ${shoe.atno}<br>
                            Colors: ${Object.keys(shoe.colors).join(', ')}<br>
                            Total Stock: ${totalStock} pairs
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterShoeSelection(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            
            if (!term) {
                renderShoeSelectionResults(cachedShoesForSelection);
                return;
            }
            
            const filtered = cachedShoesForSelection.filter(shoe => {
                if (shoe.name.toLowerCase().includes(term)) return true;
                if (shoe.atno && shoe.atno.toLowerCase().includes(term)) return true;
                return shoe.inventory.some(inv => 
                    inv.color.toLowerCase().includes(term) || 
                    inv.size.toLowerCase().includes(term)
                );
            });
            
            renderShoeSelectionResults(filtered);
        }

        async function openSizeSelectionModal(shoeId) {
            const shoes = await getShoes();
            const shoe = shoes.find(s => s.id === shoeId);
            if (!shoe) return;

            currentShoeSelection = shoe;
            tempSelectedSizes = [];
            
            document.getElementById('sizeModalTitle').textContent = `Select Sizes - ${shoe.name}`;
            document.getElementById('sizeModalPrice').value = (shoe.cost || 0) * 2;
            
            // Group inventory by color
            const colorGroups = {};
            shoe.inventory.forEach(inv => {
                if (!colorGroups[inv.color]) colorGroups[inv.color] = [];
                colorGroups[inv.color].push(inv);
            });

            const content = document.getElementById('sizeSelectionContent');
            content.innerHTML = '';

            Object.entries(colorGroups).forEach(([color, items]) => {
                if (items.length === 0) return;
                
                const colorSection = document.createElement('div');
                colorSection.className = 'color-section';
                
                const header = document.createElement('div');
                header.className = 'color-header';
                header.textContent = color;
                colorSection.appendChild(header);
                
                const colorContent = document.createElement('div');
                colorContent.className = 'color-content';
                
                const sizeGrid = document.createElement('div');
                sizeGrid.className = 'size-grid';
                
                items.forEach(item => {
                    const sizeBox = document.createElement('div');
                    sizeBox.className = 'size-box';
                    sizeBox.dataset.color = color;
                    sizeBox.dataset.size = item.size;
                    sizeBox.dataset.stock = item.qty;
                    sizeBox.dataset.id = `${color}_${item.size}`;
                    
                    if (item.qty === 0) {
                        sizeBox.classList.add('disabled');
                    }
                    
                    sizeBox.innerHTML = `
                        <div class="size-label">${item.size}</div>
                        <div class="stock-label">${item.qty} in stock</div>
                    `;
                    
                    if (item.qty > 0) {
                        sizeBox.onclick = () => toggleSizeSelection(sizeBox, color, item.size, item.qty);
                    }
                    
                    sizeGrid.appendChild(sizeBox);
                });
                
                colorContent.appendChild(sizeGrid);
                colorSection.appendChild(colorContent);
                content.appendChild(colorSection);
            });

            updateSelectedSizesPreview();
            validateSizeSelection();
            
            closeShoeSelectionModal();
            document.getElementById('sizeSelectionModal').classList.add('active');
        }

        function toggleSizeSelection(element, color, size, stock) {
            const id = `${color}_${size}`;
            const existingIndex = tempSelectedSizes.findIndex(s => s.id === id);
            
            if (existingIndex >= 0) {
                // Deselect
                tempSelectedSizes.splice(existingIndex, 1);
                element.classList.remove('selected');
            } else {
                // Select with qty 1
                tempSelectedSizes.push({
                    id: id,
                    color: color,
                    size: size,
                    stock: stock,
                    qty: 1
                });
                element.classList.add('selected');
            }
            
            updateSelectedSizesPreview();
            validateSizeSelection();
        }

        function updateSelectedSizesPreview() {
            const container = document.getElementById('sizeSelectionContent');
            let previewDiv = document.querySelector('.selected-sizes-preview');
            
            if (!previewDiv) {
                previewDiv = document.createElement('div');
                previewDiv.className = 'selected-sizes-preview';
                container.appendChild(previewDiv);
            }
            
            if (tempSelectedSizes.length === 0) {
                previewDiv.innerHTML = '<p class="text-muted text-center">No sizes selected</p>';
                return;
            }
            
            previewDiv.innerHTML = tempSelectedSizes.map(item => `
                <div class="selected-size-item">
                    <div class="selected-size-info">
                        <div class="selected-size-name">${item.color} - Size ${item.size}</div>
                        <div class="selected-size-qty">Stock: ${item.stock} | Selected: ${item.qty}</div>
                    </div>
                    <div class="quantity-control" style="margin: 0; padding: 0; background: transparent; border: none;">
                        <button type="button" class="qty-btn" onclick="updateTempQty('${item.id}', -1)" ${item.qty <= 1 ? 'disabled' : ''}>‚àí</button>
                        <span class="qty-display" style="font-size: 1.2rem; min-width: 40px;">${item.qty}</span>
                        <button type="button" class="qty-btn" onclick="updateTempQty('${item.id}', 1)" ${item.qty >= item.stock ? 'disabled' : ''}>+</button>
                    </div>
                    <button class="remove-size-btn" onclick="removeTempSize('${item.id}')">√ó</button>
                </div>
            `).join('');
        }

        function updateTempQty(id, change) {
            const item = tempSelectedSizes.find(s => s.id === id);
            if (!item) return;
            
            const newQty = item.qty + change;
            if (newQty < 1 || newQty > item.stock) return;
            
            item.qty = newQty;
            updateSelectedSizesPreview();
            validateSizeSelection();
        }

        function removeTempSize(id) {
            tempSelectedSizes = tempSelectedSizes.filter(s => s.id !== id);
            
            // Update visual selection
            const box = document.querySelector(`.size-box[data-id="${id}"]`);
            if (box) box.classList.remove('selected');
            
            updateSelectedSizesPreview();
            validateSizeSelection();
        }

        function validateSizeSelection() {
            const price = parseFloat(document.getElementById('sizeModalPrice').value);
            const hasSelection = tempSelectedSizes.length > 0;
            const validPrice = price > 0;
            
            const msg = document.getElementById('validationMessage');
            if (!hasSelection) {
                msg.textContent = 'Please select at least one size';
            } else if (!validPrice) {
                msg.textContent = 'Please enter a valid price';
            } else {
                msg.textContent = '';
            }
            
            document.getElementById('confirmSizeBtn').disabled = !(hasSelection && validPrice);
        }

        function closeSizeSelectionModal() {
            document.getElementById('sizeSelectionModal').classList.remove('active');
            currentShoeSelection = null;
            tempSelectedSizes = [];
        }

        function confirmSizeSelection() {
            const price = parseFloat(document.getElementById('sizeModalPrice').value);
            
            tempSelectedSizes.forEach(item => {
                currentSaleItems.push({
                    id: Date.now().toString() + Math.random(),
                    shoeId: currentShoeSelection.id,
                    shoeName: currentShoeSelection.name,
                    atno: currentShoeSelection.atno || 'N/A',
                    color: item.color,
                    size: item.size,
                    qty: item.qty,
                    pricePerPair: price,
                    total: item.qty * price,
                    maxStock: item.stock
                });
            });
            
            renderSaleItems();
            closeSizeSelectionModal();
        }

        document.getElementById('sizeModalPrice').addEventListener('input', validateSizeSelection);

        function removeSaleItem(id) {
            currentSaleItems = currentSaleItems.filter(i => i.id !== id);
            renderSaleItems();
        }

        function renderSaleItems() {
            const container = document.getElementById('saleItemsCart');
            if (currentSaleItems.length === 0) {
                container.innerHTML = '<p class="text-center text-muted" style="padding: 20px;">Cart is empty</p>';
            } else {
                // Group by shoe/color for better display
                const groups = {};
                currentSaleItems.forEach(item => {
                    const key = `${item.shoeId}_${item.color}`;
                    if (!groups[key]) {
                        groups[key] = {
                            shoeName: item.shoeName,
                            atno: item.atno,
                            color: item.color,
                            items: []
                        };
                    }
                    groups[key].items.push(item);
                });

                container.innerHTML = Object.values(groups).map(group => `
                    <div class="cart-item">
                        <div class="cart-item-header">${group.shoeName}</div>
                        <div class="cart-item-details">
                            ATNO: ${group.atno}<br>
                            Color: ${group.color}
                        </div>
                        <div class="cart-item-sizes">
                            ${group.items.map(item => `
                                <div class="cart-size-tag">
                                    Size ${item.size}: ${item.qty} @ KSh ${item.pricePerPair.toFixed(2)}
                                    <button onclick="removeSaleItem('${item.id}')" style="background: none; border: none; color: var(--danger-color); cursor: pointer; margin-left: 4px; font-weight: bold;">√ó</button>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 8px; text-align: right; font-weight: 600; color: var(--accent-color);">
                            Subtotal: KSh ${group.items.reduce((a, b) => a + b.total, 0).toFixed(2)}
                        </div>
                    </div>
                `).join('');
            }
            updateSaleTotal();
        }

        function updateSaleTotal() {
            const total = currentSaleItems.reduce((sum, i) => sum + i.total, 0);
            document.getElementById('grandTotal').textContent = `KSh ${total.toFixed(2)}`;
            
            const mpesa = parseFloat(document.getElementById('mpesaAmount').value) || 0;
            const cash = parseFloat(document.getElementById('cashAmount').value) || 0;
            const balanced = Math.abs((mpesa + cash) - total) < 0.01;
            
            document.getElementById('paymentStatus').textContent = balanced ? 'BALANCED ‚úì' : 'UNBALANCED';
            document.getElementById('paymentStatus').style.color = balanced ? 'var(--success-color)' : 'var(--danger-color)';
            document.getElementById('completeSaleBtn').disabled = !balanced || currentSaleItems.length === 0;
        }

        document.getElementById('mpesaAmount').addEventListener('input', updateSaleTotal);
        document.getElementById('cashAmount').addEventListener('input', updateSaleTotal);

        document.getElementById('salesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentSaleItems.length === 0) return;

            // Validate stock levels before proceeding
            const shoes = await getShoes();
            for (let item of currentSaleItems) {
                const shoe = shoes.find(s => s.id === item.shoeId);
                const inv = shoe.inventory.find(i => i.color === item.color && i.size === item.size);
                if (inv.qty < item.qty) {
                    alert(`Insufficient stock for ${item.shoeName} ${item.color} Size ${item.size}. Available: ${inv.qty}, Requested: ${item.qty}`);
                    return;
                }
            }

            const sale = {
                date: document.getElementById('saleDate').value,
                customerName: document.getElementById('customerName').value || 'Walk-in',
                items: [...currentSaleItems],
                mpesa: parseFloat(document.getElementById('mpesaAmount').value) || 0,
                cash: parseFloat(document.getElementById('cashAmount').value) || 0,
                total: currentSaleItems.reduce((sum, i) => sum + i.total, 0),
                createdAt: new Date().toISOString()
            };

            // Update inventory
            for (let item of currentSaleItems) {
                const shoe = shoes.find(s => s.id === item.shoeId);
                const inv = shoe.inventory.find(i => i.color === item.color && i.size === item.size);
                inv.qty -= item.qty;
            }

            for (let shoe of shoes) {
                await updateShoe(shoe.id, { ...shoe, updatedAt: new Date().toISOString() });
            }

            if (await saveSale(sale)) {
                alert('‚úÖ Sale completed');
                e.target.reset();
                document.getElementById('saleDate').valueAsDate = new Date();
                currentSaleItems = [];
                renderSaleItems();
                loadSales();
                loadInventory();
            }
        });

        function renderSalesList(sales) {
            const container = document.getElementById('salesList');
            if (sales.length === 0) {
                container.innerHTML = '<p class="empty-state">No sales found</p>';
                return;
            }

            container.innerHTML = sales.sort((a,b) => new Date(b.date) - new Date(a.date)).map(sale => `
                <div class="sale-item">
                    <div class="sale-header">
                        <span>Sale #${sale.id.slice(-6)}</span>
                        <strong>KSh ${sale.total.toFixed(2)}</strong>
                    </div>
                    <div class="sale-details">
                        <strong>Date:</strong> ${sale.date}<br>
                        <strong>Customer:</strong> ${sale.customerName}<br>
                        ${sale.items.map(i => `${i.qty}x ${i.shoeName} (${i.color}, ${i.size}) @ KSh ${i.pricePerPair.toFixed(2)}`).join('<br>')}
                        <br><strong>Payment:</strong> M-Pesa: KSh ${sale.mpesa.toFixed(2)} | Cash: KSh ${sale.cash.toFixed(2)}
                    </div>
                    <div class="sale-actions">
                        <button onclick="editSale('${sale.id}')" class="btn-secondary btn-small">Edit</button>
                        <button onclick="deleteSale('${sale.id}')" class="btn-danger btn-small">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadSales() {
            const sales = await getSales();
            allSalesData = sales;
            renderSalesList(sales);
        }

        async function editSale(id) {
            const sales = await getSales();
            const sale = sales.find(s => s.id === id);
            if (!sale) return;

            editingSaleId = id;
            saleItemsForEdit = JSON.parse(JSON.stringify(sale.items));
            
            document.getElementById('editSaleDate').value = sale.date;
            document.getElementById('editCustomerName').value = sale.customerName;
            document.getElementById('editMpesaAmount').value = sale.mpesa;
            document.getElementById('editCashAmount').value = sale.cash;
            
            renderEditSaleItems();
            document.getElementById('editSaleModal').classList.add('active');
        }

        function renderEditSaleItems() {
            const container = document.getElementById('editSaleItemsCart');
            if (saleItemsForEdit.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No items</p>';
            } else {
                container.innerHTML = saleItemsForEdit.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-header">${item.shoeName}</div>
                        <div class="cart-item-details">${item.color} - Size ${item.size}</div>
                        <div class="cart-item-actions">
                            <input type="number" value="${item.qty}" min="1" onchange="updateEditItemQty('${item.id}', this.value)">
                            <input type="number" value="${item.pricePerPair}" min="0" step="0.01" onchange="updateEditItemPrice('${item.id}', this.value)">
                            <button onclick="removeEditItem('${item.id}')" class="btn-danger btn-small">Remove</button>
                        </div>
                    </div>
                `).join('');
            }
            updateEditTotal();
        }

        function updateEditItemQty(id, qty) {
            const item = saleItemsForEdit.find(i => i.id === id);
            if (item) {
                item.qty = parseInt(qty);
                item.total = item.qty * item.pricePerPair;
                renderEditSaleItems();
            }
        }

        function updateEditItemPrice(id, price) {
            const item = saleItemsForEdit.find(i => i.id === id);
            if (item) {
                item.pricePerPair = parseFloat(price);
                item.total = item.qty * item.pricePerPair;
                renderEditSaleItems();
            }
        }

        function removeEditItem(id) {
            saleItemsForEdit = saleItemsForEdit.filter(i => i.id !== id);
            renderEditSaleItems();
        }

        function updateEditTotal() {
            const total = saleItemsForEdit.reduce((sum, i) => sum + i.total, 0);
            document.getElementById('editGrandTotal').textContent = `KSh ${total.toFixed(2)}`;
        }

        function closeEditSaleModal() {
            document.getElementById('editSaleModal').classList.remove('active');
            editingSaleId = null;
        }

        document.getElementById('editSaleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (saleItemsForEdit.length === 0) return;

            const data = {
                date: document.getElementById('editSaleDate').value,
                customerName: document.getElementById('editCustomerName').value,
                items: saleItemsForEdit,
                mpesa: parseFloat(document.getElementById('editMpesaAmount').value) || 0,
                cash: parseFloat(document.getElementById('editCashAmount').value) || 0,
                total: saleItemsForEdit.reduce((sum, i) => sum + i.total, 0),
                updatedAt: new Date().toISOString()
            };

            if (await updateSale(editingSaleId, data)) {
                closeEditSaleModal();
                loadSales();
                alert('‚úÖ Sale updated');
            }
        });

        async function deleteSale(id) {
            if (!confirm('Delete this sale? Inventory will be restored.')) return;
            
            const sales = await getSales();
            const sale = sales.find(s => s.id === id);
            
            const shoes = await getShoes();
            for (let item of sale.items) {
                const shoe = shoes.find(s => s.id === item.shoeId);
                const inv = shoe.inventory.find(i => i.color === item.color && i.size === item.size);
                if (inv) inv.qty += item.qty;
            }
            
            for (let shoe of shoes) {
                await updateShoe(shoe.id, shoe);
            }
            
            if (await deleteSaleFromStorage(id)) {
                loadSales();
                loadInventory();
                alert('‚úÖ Sale deleted');
            }
        }

        function openTransferSelectionModal() {
            document.getElementById('transferSelectionModal').classList.add('active');
            document.getElementById('transferSelectionSearch').value = '';
            loadTransferSelection();
        }

        function closeTransferSelectionModal() {
            document.getElementById('transferSelectionModal').classList.remove('active');
        }

        async function loadTransferSelection() {
            const shoes = await getShoes();
            const container = document.getElementById('transferSelectionResults');
            
            let variants = [];
            shoes.forEach(shoe => {
                shoe.inventory.forEach(inv => {
                    if (inv.qty > 0) {
                        variants.push({ 
                            ...inv, 
                            shoeId: shoe.id, 
                            shoeName: shoe.name, 
                            atno: shoe.atno 
                        });
                    }
                });
            });

            if (variants.length === 0) {
                container.innerHTML = '<p class="empty-state">No items found</p>';
                return;
            }

            container.innerHTML = variants.map(v => `
                <div class="variant-card">
                    <div class="variant-title">${v.shoeName}</div>
                    <div class="variant-info">
                        ATNO: ${v.atno}<br>
                        ${v.color} - Size ${v.size}<br>
                        Stock: ${v.qty} pairs
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input type="number" placeholder="Qty" min="1" max="${v.qty}" class="transfer-qty" style="flex: 1;">
                        <button onclick="addToTransfer('${v.shoeId}', '${v.color}', '${v.size}', '${v.shoeName}', '${v.atno}', this)" class="btn-success btn-small">Add</button>
                    </div>
                </div>
            `).join('');
        }

        function filterTransferSelection(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            const cards = document.querySelectorAll('#transferSelectionResults .variant-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        function addToTransfer(shoeId, color, size, shoeName, atno, btn) {
            const qty = parseInt(btn.previousElementSibling.value);
            if (!qty || qty < 1) {
                alert('Please enter a valid quantity');
                return;
            }
            
            // Check if already in cart
            const existing = currentTransferItems.find(i => 
                i.shoeId === shoeId && i.color === color && i.size === size
            );
            
            if (existing) {
                existing.qty += qty;
            } else {
                currentTransferItems.push({
                    id: Date.now().toString(),
                    shoeId, color, size, shoeName, atno, qty
                });
            }
            
            renderTransferItems();
            closeTransferSelectionModal();
        }

        function removeTransferItem(id) {
            currentTransferItems = currentTransferItems.filter(i => i.id !== id);
            renderTransferItems();
        }

        function renderTransferItems() {
            const container = document.getElementById('transferItemsCart');
            if (currentTransferItems.length === 0) {
                container.innerHTML = '<p class="text-center text-muted" style="padding: 20px;">No items added</p>';
                document.getElementById('completeTransferBtn').disabled = true;
            } else {
                container.innerHTML = currentTransferItems.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-header">${item.shoeName}</div>
                        <div class="cart-item-details">${item.color} - Size ${item.size} | Qty: ${item.qty}</div>
                        <button onclick="removeTransferItem('${item.id}')" class="btn-danger btn-small" style="width: auto; margin-top: 8px;">Remove</button>
                    </div>
                `).join('');
                document.getElementById('completeTransferBtn').disabled = false;
            }
        }

        document.getElementById('transferForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentTransferItems.length === 0) return;

            const location = document.getElementById('transferLocation').value;
            const date = document.getElementById('transferDate').value;

            const shoes = await getShoes();
            for (let item of currentTransferItems) {
                const shoe = shoes.find(s => s.id === item.shoeId);
                const inv = shoe.inventory.find(i => i.color === item.color && i.size === item.size);
                if (inv.qty < item.qty) {
                    alert(`Insufficient stock for ${item.shoeName}`);
                    return;
                }
                inv.qty -= item.qty;
            }

            for (let shoe of shoes) {
                await updateShoe(shoe.id, shoe);
            }

            let success = true;
            for (let item of currentTransferItems) {
                if (!await saveTransfer({
                    date,
                    location,
                    shoeId: item.shoeId,
                    shoeName: item.shoeName,
                    color: item.color,
                    size: item.size,
                    qty: item.qty,
                    createdAt: new Date().toISOString()
                })) success = false;
            }

            if (success) {
                alert('‚úÖ Transfer completed');
                e.target.reset();
                document.getElementById('transferDate').valueAsDate = new Date();
                currentTransferItems = [];
                renderTransferItems();
                loadTransfers();
                loadInventory();
            }
        });

        async function loadTransfers() {
            const transfers = await getTransfers();
            const container = document.getElementById('transfersList');
            
            if (transfers.length === 0) {
                container.innerHTML = '<p class="empty-state">No transfers found</p>';
                return;
            }

            const groups = {};
            transfers.forEach(t => {
                const key = `${t.date}_${t.location}`;
                if (!groups[key]) groups[key] = { date: t.date, location: t.location, items: [], id: t.id };
                groups[key].items.push(t);
            });

            container.innerHTML = Object.values(groups).sort((a,b) => new Date(b.date) - new Date(a.date)).map(group => `
                <div class="sale-item">
                    <div class="sale-header">
                        <span>Transfer to ${group.location}</span>
                        <span>${group.date}</span>
                    </div>
                    <div class="sale-details">
                        ${group.items.map(i => `${i.qty}x ${i.shoeName} (${i.color}, ${i.size})`).join('<br>')}
                    </div>
                </div>
            `).join('');
        }

        async function generateReport() {
            const from = document.getElementById('reportFromDate').value;
            const to = document.getElementById('reportToDate').value;
            
            const sales = (await getSales()).filter(s => {
                if (from && s.date < from) return false;
                if (to && s.date > to) return false;
                return true;
            });

            const totalSales = sales.reduce((sum, s) => sum + s.total, 0);
            const totalMpesa = sales.reduce((sum, s) => sum + s.mpesa, 0);
            const totalCash = sales.reduce((sum, s) => sum + s.cash, 0);
            const totalPairs = sales.reduce((sum, s) => sum + s.items.reduce((a,b) => a + b.qty, 0), 0);

            document.getElementById('reportContent').innerHTML = `
                <div class="stat-card">
                    <div class="stat-row">
                        <span class="stat-label">Total Sales</span>
                        <span class="stat-value">KSh ${totalSales.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">M-Pesa Payments</span>
                        <span class="stat-value">KSh ${totalMpesa.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Cash Payments</span>
                        <span class="stat-value">KSh ${totalCash.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Pairs Sold</span>
                        <span class="stat-value">${totalPairs}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Transactions</span>
                        <span class="stat-value">${sales.length}</span>
                    </div>
                </div>
            `;
        }

        async function downloadInventoryCSV() {
            const shoes = await getShoes();
            let csv = 'Name,ATNO,Supplier,Cost,Color,Size,Qty\n';
            shoes.forEach(shoe => {
                shoe.inventory.forEach(inv => {
                    csv += `"${shoe.name}","${shoe.atno}","${shoe.supplier}",${shoe.cost},"${inv.color}","${inv.size}",${inv.qty}\n`;
                });
            });
            downloadCSV(csv, 'inventory.csv');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        function downloadSalesCSV() { 
            getSales().then(sales => {
                let csv = 'Date,Customer,Shoe,Color,Size,Qty,Price,Total,Mpesa,Cash\n';
                sales.forEach(sale => {
                    sale.items.forEach(item => {
                        csv += `"${sale.date}","${sale.customerName}","${item.shoeName}","${item.color}","${item.size}",${item.qty},${item.pricePerPair},${item.total},${sale.mpesa},${sale.cash}\n`;
                    });
                });
                downloadCSV(csv, 'sales.csv');
            });
        }
        
        function downloadTransfersCSV() { 
            getTransfers().then(transfers => {
                let csv = 'Date,Location,Shoe,Color,Size,Qty\n';
                transfers.forEach(t => {
                    csv += `"${t.date}","${t.location}","${t.shoeName}","${t.color}","${t.size}",${t.qty}\n`;
                });
                downloadCSV(csv, 'transfers.csv');
            });
        }
        
        function downloadReport() { 
            const content = document.getElementById('reportContent').innerText;
            if (!content || content.includes('No data')) {
                alert('Generate a report first');
                return;
            }
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report.txt';
            a.click();
        }
    </script>
</body>
</html>
