<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoe Inventory System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e8e6e3;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #f5f3f0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 30px;
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #c8c6c3;
            font-weight: 500;
        }

        .tab:hover {
            background: #3a3a3a;
            border-color: #4a4a4a;
        }

        .tab.active {
            background: #f5f3f0;
            color: #1a1a1a;
            border-color: #f5f3f0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-card {
            background: #252525;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #d8d6d3;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 2px solid #3a3a3a;
            border-radius: 12px;
            color: #e8e6e3;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f5f3f0;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        button {
            padding: 12px 30px;
            background: #f5f3f0;
            color: #1a1a1a;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        button:hover {
            background: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245,243,240,0.3);
        }

        .btn-secondary {
            background: #3a3a3a;
            color: #e8e6e3;
        }

        .btn-secondary:hover {
            background: #4a3a4a;
        }

        .btn-danger {
            background: #d32f2f;
            color: white;
        }

        .btn-danger:hover {
            background: #b71c1c;
        }

        .btn-success {
            background: #43a047;
            color: white;
        }

        .btn-success:hover {
            background: #2e7d32;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .shoe-card {
            background: #252525;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .shoe-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .shoe-card h3 {
            color: #f5f3f0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .shoe-detail {
            margin: 8px 0;
            color: #c8c6c3;
            font-size: 14px;
        }

        .shoe-detail strong {
            color: #e8e6e3;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .card-actions button {
            flex: 1;
            padding: 8px;
            font-size: 13px;
        }

        .bulk-entry {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
        }

        .color-group {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #3a3a3a;
        }

        .color-header {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .size-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 8px;
            align-items: end;
        }

        .payment-split {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
        }

        .report-card {
            background: #252525;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .report-stat {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #3a3a3a;
        }

        .report-stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #c8c6c3;
        }

        .stat-value {
            color: #f5f3f0;
            font-weight: 600;
            font-size: 1.1em;
        }

        .sales-list {
            margin-top: 20px;
        }

        .sale-item {
            background: #252525;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .sale-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #f5f3f0;
            font-weight: 600;
        }

        .sale-details {
            color: #c8c6c3;
            font-size: 14px;
        }

        .color-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #3a3a3a;
            border-radius: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .search-box {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #252525;
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
            margin-top: 5px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #3a3a3a;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: #2a2a2a;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #252525;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: #d32f2f;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar input[type="text"] {
            flex: 1;
            min-width: 250px;
        }

        .toolbar button {
            white-space: nowrap;
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-label {
            padding: 12px 30px;
            background: #43a047;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-block;
        }

        .file-upload-label:hover {
            background: #2e7d32;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67,160,71,0.3);
        }

        .info-banner {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #f5f3f0;
        }

        .info-banner p {
            margin: 5px 0;
            color: #c8c6c3;
            font-size: 14px;
        }

        /* NEW STYLES FOR ENHANCED SALES & TRANSFERS */
        .sale-items-cart, .transfer-items-cart {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 150px;
        }

        .cart-item {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .cart-item-header {
            font-weight: 600;
            color: #f5f3f0;
            margin-bottom: 5px;
        }

        .cart-item-detail {
            font-size: 13px;
            color: #c8c6c3;
        }

        .cart-item input {
            padding: 8px;
            font-size: 13px;
        }

        .cart-item .btn-danger {
            padding: 8px 12px;
            font-size: 12px;
        }

        .add-item-btn {
            width: 100%;
            margin-bottom: 20px;
        }

        .shoe-selection-modal .modal-content {
            max-width: 800px;
        }

        .shoe-variant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .variant-card {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #3a3a3a;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .variant-card:hover {
            border-color: #f5f3f0;
            background: #3a3a3a;
        }

        .variant-card.selected {
            border-color: #43a047;
            background: #2d4a2d;
        }

        .variant-info {
            font-size: 13px;
            color: #c8c6c3;
            margin-top: 8px;
        }

        .variant-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .variant-actions input {
            flex: 1;
        }

        .variant-actions button {
            padding: 8px;
            font-size: 12px;
        }

        /* Add All Variants Button */
        .add-all-variants-btn {
            width: 100%;
            margin-top: 10px;
            background: #3a3a3a;
            color: #e8e6e3;
        }

        .add-all-variants-btn:hover {
            background: #4a4a4a;
        }

        /* Transfer Filter Toolbar */
        .filter-toolbar {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto auto;
            gap: 10px;
            margin-bottom: 20px;
            align-items: end;
        }

        @media (max-width: 768px) {
            .sales-form {
                grid-template-columns: 1fr;
            }

            .size-row {
                grid-template-columns: 1fr;
            }

            .inventory-grid {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
            }

            .toolbar input[type="text"] {
                width: 100%;
            }

            .cart-item {
                grid-template-columns: 1fr;
            }

            .filter-toolbar {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shoe Inventory System</h1>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('inventory')">Inventory</div>
            <div class="tab" onclick="switchTab('sales')">Sales</div>
            <div class="tab" onclick="switchTab('transfers')">Transfers</div>
            <div class="tab" onclick="switchTab('report')">Reports</div>
        </div>

        <!-- INVENTORY TAB -->
        <div id="inventory" class="tab-content active">
            <div class="form-card">
                <h2 style="margin-bottom: 20px;">Add Inventory</h2>
                <form id="inventoryForm">
                    <div class="form-group">
                        <label>Inventory Date</label>
                        <input type="date" id="invDate" required>
                    </div>
                    <div class="form-group">
                        <label>Shoe Name</label>
                        <input type="text" id="shoeName" placeholder="e.g., Nike Air Max" required>
                    </div>
                    <div class="form-group">
                        <label>ATNO (Article Number)</label>
                        <input type="text" id="atno" placeholder="N/A" value="N/A">
                    </div>
                    <div class="form-group">
                        <label>Supplier Name</label>
                        <input type="text" id="supplierName" placeholder="Supplier name">
                    </div>
                    <div class="form-group">
                        <label>Cost per Pair</label>
                        <input type="number" id="costPerPair" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Inventory Entry (by Color)</label>
                        <div class="bulk-entry">
                            <div id="colorGroups"></div>
                            <button type="button" onclick="addColorGroup()" class="btn-secondary">+ Add Color</button>
                        </div>
                    </div>
                    <button type="submit">Add to Inventory</button>
                </form>
            </div>

            <div class="info-banner">
                <p><strong>Data Management:</strong></p>
                <p>â€¢ Download your inventory as CSV to backup or transfer to another browser</p>
                <p>â€¢ Upload a CSV file to add to your existing inventory data</p>
            </div>

            <div class="toolbar">
                <input type="text" id="inventorySearch" placeholder="Search inventory by name, ATNO, color, or size... (use commas for multiple)">
                <button onclick="downloadInventoryCSV()" class="btn-secondary">ðŸ“¥ Download Inventory</button>
                <label for="inventoryUpload" class="file-upload-label">ðŸ“¤ Upload Inventory</label>
                <input type="file" id="inventoryUpload" accept=".csv" onchange="uploadInventoryCSV(event)">
            </div>

            <h2 style="margin-bottom: 15px;">Current Inventory</h2>
            <div id="inventoryList" class="inventory-grid"></div>
        </div>

        <!-- SALES TAB -->
        <div id="sales" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 20px;">Record Sale</h2>
                <form id="salesForm">
                    <div class="sales-form">
                        <div>
                            <div class="form-group">
                                <label>Sale Date</label>
                                <input type="date" id="saleDate" required>
                            </div>
                            <div class="form-group">
                                <label>Customer Name (Optional)</label>
                                <input type="text" id="customerName" placeholder="Customer name">
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="add-item-btn btn-success" onclick="openShoeSelectionModal()">+ Add Item to Sale</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Sale Items</label>
                        <div id="saleItemsCart" class="sale-items-cart">
                            <p style="text-align: center; color: #c8c6c3; padding: 30px;">No items added. Click "Add Item to Sale" to begin.</p>
                        </div>
                    </div>

                    <div class="payment-split">
                        <h3 style="margin-bottom: 15px;">Payment Method</h3>
                        <div class="form-group">
                            <label>M-Pesa Amount</label>
                            <input type="number" id="mpesaAmount" min="0" step="0.01" value="0" required>
                        </div>
                        <div class="form-group">
                            <label>Cash Amount</label>
                            <input type="number" id="cashAmount" min="0" step="0.01" value="0" required>
                        </div>
                        <div class="form-group">
                            <label style="font-size: 1.2em;">Grand Total: <span id="grandTotal" style="color: #43a047; font-weight: 700;">KSh 0.00</span></label>
                        </div>
                        <div class="form-group">
                            <label>Payment Status: <span id="paymentStatus" style="color: #d32f2f;">UNBALANCED</span></label>
                        </div>
                    </div>

                    <button type="submit" style="margin-top: 20px; width: 100%;" id="completeSaleBtn" disabled>Complete Sale</button>
                </form>
            </div>

            <div class="toolbar" style="justify-content: flex-end;">
                <button onclick="downloadSalesCSV()" class="btn-secondary">ðŸ“¥ Download Sales</button>
                <label for="salesUpload" class="file-upload-label">ðŸ“¤ Upload Sales</label>
                <input type="file" id="salesUpload" accept=".csv" onchange="uploadSalesCSV(event)">
            </div>

            <h2 style="margin-bottom: 15px;">Recent Sales</h2>
            <div id="salesList" class="sales-list"></div>
        </div>

        <!-- TRANSFERS TAB -->
        <div id="transfers" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 20px;">Record Transfer</h2>
                <form id="transferForm">
                    <div class="sales-form">
                        <div>
                            <div class="form-group">
                                <label>Transfer Date</label>
                                <input type="date" id="transferDate" required>
                            </div>
                            <div class="form-group">
                                <label>Transfer To (Location)</label>
                                <input type="text" id="transferLocation" placeholder="e.g., Downtown Store" required>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="add-item-btn btn-success" onclick="openTransferSelectionModal()">+ Add Item to Transfer</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Transfer Items</label>
                        <div id="transferItemsCart" class="transfer-items-cart">
                            <p style="text-align: center; color: #c8c6c3; padding: 30px;">No items added. Click "Add Item to Transfer" to begin.</p>
                        </div>
                    </div>

                    <button type="submit" style="margin-top: 20px; width: 100%;" id="completeTransferBtn" disabled>Complete Transfer</button>
                </form>
            </div>

            <!-- Transfer Filter Toolbar -->
            <div class="filter-toolbar">
                <input type="text" id="transferSearch" placeholder="Search transfers by shoe name, ATNO, color, or size...">
                <input type="date" id="transferFromDate" placeholder="From Date">
                <input type="date" id="transferToDate" placeholder="To Date">
                <button onclick="loadTransfers()" class="btn-secondary">Filter</button>
                <button onclick="clearTransferFilters()" class="btn-secondary">Clear</button>
            </div>

            <div class="toolbar" style="justify-content: flex-end;">
                <button onclick="downloadTransfersCSV()" class="btn-secondary">ðŸ“¥ Download Transfers</button>
                <label for="transfersUpload" class="file-upload-label">ðŸ“¤ Upload Transfers</label>
                <input type="file" id="transfersUpload" accept=".csv" onchange="uploadTransfersCSV(event)">
            </div>

            <h2 style="margin-bottom: 15px;">Transfer History</h2>
            <div id="transfersList" class="sales-list"></div>
        </div>

        <!-- REPORT TAB -->
        <div id="report" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 20px;">Filter Reports</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px;">
                    <div class="form-group">
                        <label>From Date</label>
                        <input type="date" id="reportFromDate">
                    </div>
                    <div class="form-group">
                        <label>To Date</label>
                        <input type="date" id="reportToDate">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button onclick="generateReport()">Generate Report</button>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button onclick="downloadReport()" class="btn-secondary">Download Report</button>
                    </div>
                </div>
            </div>

            <div id="reportContent"></div>
        </div>
    </div>

    <!-- Edit Inventory Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Inventory Item</h2>
                <button class="close-btn" onclick="closeEditModal()">âœ•</button>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label>Inventory Date</label>
                    <input type="date" id="editInvDate" required>
                </div>
                <div class="form-group">
                    <label>Shoe Name</label>
                    <input type="text" id="editShoeName" required>
                </div>
                <div class="form-group">
                    <label>ATNO</label>
                    <input type="text" id="editAtno">
                </div>
                <div class="form-group">
                    <label>Supplier Name</label>
                    <input type="text" id="editSupplierName">
                </div>
                <div class="form-group">
                    <label>Cost per Pair</label>
                    <input type="number" id="editCostPerPair" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Inventory (by Color)</label>
                    <div class="bulk-entry">
                        <div id="editColorGroups"></div>
                        <button type="button" onclick="addEditColorGroup()" class="btn-secondary">+ Add Color</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" style="flex: 1;">Update Item</button>
                    <button type="button" onclick="closeEditModal()" class="btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shoe Selection Modal for Sales -->
    <div id="shoeSelectionModal" class="modal shoe-selection-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Shoe & Variant</h2>
                <button class="close-btn" onclick="closeShoeSelectionModal()">âœ•</button>
            </div>
            <div class="form-group">
                <input type="text" id="shoeSelectionSearch" placeholder="Search by name, ATNO, color, or size..." style="margin-bottom: 20px;">
            </div>
            <div id="shoeSelectionResults" class="shoe-variant-grid"></div>
        </div>
    </div>

    <!-- Variant Selection Modal for Transfers -->
    <div id="transferSelectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Shoe & Variant for Transfer</h2>
                <button class="close-btn" onclick="closeTransferSelectionModal()">âœ•</button>
            </div>
            <div class="form-group">
                <input type="text" id="transferSelectionSearch" placeholder="Search by name, ATNO, color, or size..." style="margin-bottom: 20px;">
            </div>
            <div id="transferSelectionResults" class="shoe-variant-grid"></div>
        </div>
    </div>

    <!-- Edit Sale Modal -->
    <div id="editSaleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Sale</h2>
                <button class="close-btn" onclick="closeEditSaleModal()">âœ•</button>
            </div>
            <form id="editSaleForm">
                <div class="form-group">
                    <label>Sale Date</label>
                    <input type="date" id="editSaleDate" required>
                </div>
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" id="editCustomerName">
                </div>
                <div class="form-group">
                    <label>Sale Items</label>
                    <div id="editSaleItemsCart" class="sale-items-cart"></div>
                    <button type="button" class="btn-secondary" style="width: 100%; margin-top: 10px;" onclick="openShoeSelectionModalForEdit()">+ Add Item to Sale</button>
                </div>
                <div class="payment-split">
                    <h3 style="margin-bottom: 15px;">Payment Method</h3>
                    <div class="form-group">
                        <label>M-Pesa Amount</label>
                        <input type="number" id="editMpesaAmount" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Cash Amount</label>
                        <input type="number" id="editCashAmount" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label style="font-size: 1.2em;">Grand Total: <span id="editGrandTotal" style="color: #43a047; font-weight: 700;">KSh 0.00</span></label>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" style="flex: 1;">Update Sale</button>
                    <button type="button" onclick="closeEditSaleModal()" class="btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let selectedShoeId = null;
        let transferSelectedShoeId = null;
        let editingShoeId = null;
        let currentSaleItems = [];
        let editingSaleId = null;
        let saleItemsForEdit = [];
        let currentTransferItems = [];

        // Initialize dates
        document.getElementById('invDate').valueAsDate = new Date();
        document.getElementById('saleDate').valueAsDate = new Date();
        document.getElementById('transferDate').valueAsDate = new Date();

        // Add initial color group
        addColorGroup();

        // Inventory search functionality (supports comma-separated terms)
        document.getElementById('inventorySearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            loadInventory(query);
        });

        // Shoe selection search
        document.getElementById('shoeSelectionSearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            displayShoeVariants(query);
        });

        // Transfer selection search
        document.getElementById('transferSelectionSearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            displayTransferVariants(query);
        });

        // Transfer filter search
        document.getElementById('transferSearch').addEventListener('input', function(e) {
            loadTransfers();
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'inventory') loadInventory();
            if (tabName === 'sales') loadSales();
            if (tabName === 'transfers') loadTransfers();
            if (tabName === 'report') generateReport();
        }

        function addColorGroup() {
            const container = document.getElementById('colorGroups');
            const groupDiv = document.createElement('div');
            groupDiv.className = 'color-group';
            groupDiv.innerHTML = `
                <div class="color-header">
                    <input type="text" placeholder="Color name" class="color-input" style="flex: 1;">
                    <button type="button" onclick="this.closest('.color-group').remove()" class="btn-danger">Remove Color</button>
                </div>
                <div class="sizes-container"></div>
                <button type="button" onclick="addSizeToGroup(this)" class="btn-secondary" style="width: 100%; margin-top: 10px;">+ Add Size</button>
            `;
            container.appendChild(groupDiv);
            addSizeToGroup(groupDiv.querySelector('button'));
        }

        function addSizeToGroup(btn) {
            const group = btn.closest('.color-group');
            const container = group.querySelector('.sizes-container');
            const sizeRow = document.createElement('div');
            sizeRow.className = 'size-row';
            sizeRow.innerHTML = `
                <input type="text" placeholder="Size" class="size-input">
                <input type="number" placeholder="Quantity" min="1" class="qty-input">
                <button type="button" onclick="this.parentElement.remove()" class="btn-danger">Remove</button>
            `;
            container.appendChild(sizeRow);
        }

        function addEditColorGroup() {
            const container = document.getElementById('editColorGroups');
            const groupDiv = document.createElement('div');
            groupDiv.className = 'color-group';
            groupDiv.innerHTML = `
                <div class="color-header">
                    <input type="text" placeholder="Color name" class="color-input" style="flex: 1;">
                    <button type="button" onclick="this.closest('.color-group').remove()" class="btn-danger">Remove Color</button>
                </div>
                <div class="sizes-container"></div>
                <button type="button" onclick="addEditSizeToGroup(this)" class="btn-secondary" style="width: 100%; margin-top: 10px;">+ Add Size</button>
            `;
            container.appendChild(groupDiv);
            addEditSizeToGroup(groupDiv.querySelector('button'));
        }

        function addEditSizeToGroup(btn) {
            const group = btn.closest('.color-group');
            const container = group.querySelector('.sizes-container');
            const sizeRow = document.createElement('div');
            sizeRow.className = 'size-row';
            sizeRow.innerHTML = `
                <input type="text" placeholder="Size" class="size-input">
                <input type="number" placeholder="Quantity" min="1" class="qty-input">
                <button type="button" onclick="this.parentElement.remove()" class="btn-danger">Remove</button>
            `;
            container.appendChild(sizeRow);
        }

        // INVENTORY FORM
        document.getElementById('inventoryForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const invDate = document.getElementById('invDate').value;
            const shoeName = document.getElementById('shoeName').value;
            const atno = document.getElementById('atno').value || 'N/A';
            const supplierName = document.getElementById('supplierName').value || 'N/A';
            const costPerPair = parseFloat(document.getElementById('costPerPair').value) || 0;

            const colorGroups = document.querySelectorAll('#colorGroups .color-group');
            const inventory = [];

            colorGroups.forEach(group => {
                const color = group.querySelector('.color-input').value.trim();
                if (!color) return;

                const sizeRows = group.querySelectorAll('.size-row');
                sizeRows.forEach(row => {
                    const size = row.querySelector('.size-input').value.trim();
                    const qty = parseInt(row.querySelector('.qty-input').value);
                    if (size && qty) {
                        inventory.push({ color, size, qty });
                    }
                });
            });

            if (inventory.length === 0) {
                alert('Please add at least one color with size and quantity');
                return;
            }

            const shoe = {
                id: Date.now().toString(),
                date: invDate,
                name: shoeName,
                atno: atno,
                supplier: supplierName,
                cost: costPerPair,
                inventory: inventory
            };

            saveShoe(shoe);
            this.reset();
            document.getElementById('invDate').valueAsDate = new Date();
            document.getElementById('atno').value = 'N/A';
            document.getElementById('colorGroups').innerHTML = '';
            addColorGroup();
            loadInventory();
            alert('Inventory added successfully!');
        });

        function saveShoe(shoe) {
            const shoes = getShoes();
            shoes.push(shoe);
            localStorage.setItem('shoes', JSON.stringify(shoes));
        }

        function getShoes() {
            return JSON.parse(localStorage.getItem('shoes') || '[]');
        }

        function loadInventory(searchQuery = '') {
            const shoes = getShoes();
            const container = document.getElementById('inventoryList');
            
            let filteredShoes = shoes;
            if (searchQuery) {
                const terms = searchQuery.toLowerCase().split(',').map(t => t.trim()).filter(t => t);
                filteredShoes = shoes.filter(shoe => {
                    return terms.some(term => {
                        const nameMatch = shoe.name.toLowerCase().includes(term);
                        const atnoMatch = shoe.atno.toLowerCase().includes(term);
                        const colorMatch = shoe.inventory.some(inv => inv.color.toLowerCase().includes(term));
                        const sizeMatch = shoe.inventory.some(inv => inv.size.toLowerCase().includes(term));
                        return nameMatch || atnoMatch || colorMatch || sizeMatch;
                    });
                });
            }

            if (filteredShoes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3;">No inventory items found</p>';
                return;
            }

            container.innerHTML = filteredShoes.map(shoe => {
                const totalPairs = shoe.inventory.reduce((sum, inv) => sum + inv.qty, 0);
                const colors = [...new Set(shoe.inventory.map(inv => inv.color))];
                
                return `
                    <div class="shoe-card">
                        <h3>${shoe.name}</h3>
                        <div class="shoe-detail"><strong>ATNO:</strong> ${shoe.atno}</div>
                        <div class="shoe-detail"><strong>Date Added:</strong> ${shoe.date}</div>
                        <div class="shoe-detail"><strong>Supplier:</strong> ${shoe.supplier || 'N/A'}</div>
                        <div class="shoe-detail"><strong>Cost:</strong> KSh ${(shoe.cost || 0).toFixed(2)}</div>
                        <div class="shoe-detail"><strong>Total Pairs:</strong> ${totalPairs}</div>
                        <div class="shoe-detail">
                            <strong>Colors:</strong><br>
                            ${colors.map(c => `<span class="color-badge">${c}</span>`).join('')}
                        </div>
                        <div class="shoe-detail">
                            <strong>Inventory:</strong><br>
                            ${shoe.inventory.map(inv => `${inv.color} - Size ${inv.size}: ${inv.qty} pairs`).join('<br>')}
                        </div>
                        <div class="card-actions">
                            <button onclick="editShoe('${shoe.id}')" class="btn-secondary">Edit</button>
                            <button onclick="deleteShoe('${shoe.id}')" class="btn-danger">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteShoe(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            const shoes = getShoes().filter(s => s.id !== id);
            localStorage.setItem('shoes', JSON.stringify(shoes));
            loadInventory();
        }

        function editShoe(id) {
            const shoe = getShoes().find(s => s.id === id);
            if (!shoe) return;

            editingShoeId = id;
            
            document.getElementById('editInvDate').value = shoe.date;
            document.getElementById('editShoeName').value = shoe.name;
            document.getElementById('editAtno').value = shoe.atno;
            document.getElementById('editSupplierName').value = shoe.supplier || '';
            document.getElementById('editCostPerPair').value = shoe.cost || 0;

            document.getElementById('editColorGroups').innerHTML = '';
            
            const colorMap = {};
            shoe.inventory.forEach(inv => {
                if (!colorMap[inv.color]) {
                    colorMap[inv.color] = [];
                }
                colorMap[inv.color].push({ size: inv.size, qty: inv.qty });
            });

            Object.keys(colorMap).forEach(color => {
                addEditColorGroup();
                const colorGroups = document.querySelectorAll('#editColorGroups .color-group');
                const lastGroup = colorGroups[colorGroups.length - 1];
                lastGroup.querySelector('.color-input').value = color;
                
                lastGroup.querySelector('.sizes-container').innerHTML = '';
                colorMap[color].forEach(sizeInfo => {
                    addEditSizeToGroup(lastGroup.querySelector('button'));
                    const sizeRows = lastGroup.querySelectorAll('.size-row');
                    const lastRow = sizeRows[sizeRows.length - 1];
                    lastRow.querySelector('.size-input').value = sizeInfo.size;
                    lastRow.querySelector('.qty-input').value = sizeInfo.qty;
                });
            });

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingShoeId = null;
        }

        // EDIT FORM SUBMIT
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const invDate = document.getElementById('editInvDate').value;
            const shoeName = document.getElementById('editShoeName').value;
            const atno = document.getElementById('editAtno').value || 'N/A';
            const supplierName = document.getElementById('editSupplierName').value || 'N/A';
            const costPerPair = parseFloat(document.getElementById('editCostPerPair').value) || 0;

            const colorGroups = document.querySelectorAll('#editColorGroups .color-group');
            const inventory = [];

            colorGroups.forEach(group => {
                const color = group.querySelector('.color-input').value.trim();
                if (!color) return;

                const sizeRows = group.querySelectorAll('.size-row');
                sizeRows.forEach(row => {
                    const size = row.querySelector('.size-input').value.trim();
                    const qty = parseInt(row.querySelector('.qty-input').value);
                    if (size && qty) {
                        inventory.push({ color, size, qty });
                    }
                });
            });

            if (inventory.length === 0) {
                alert('Please add at least one color with size and quantity');
                return;
            }

            const shoes = getShoes();
            const shoeIndex = shoes.findIndex(s => s.id === editingShoeId);
            
            if (shoeIndex !== -1) {
                shoes[shoeIndex] = {
                    id: editingShoeId,
                    date: invDate,
                    name: shoeName,
                    atno: atno,
                    supplier: supplierName,
                    cost: costPerPair,
                    inventory: inventory
                };
                localStorage.setItem('shoes', JSON.stringify(shoes));
                closeEditModal();
                loadInventory();
                alert('Inventory updated successfully!');
            }
        });

        // SALES FUNCTIONALITY
        function openShoeSelectionModal() {
            document.getElementById('shoeSelectionModal').classList.add('active');
            document.getElementById('shoeSelectionSearch').value = '';
            displayShoeVariants();
        }

        function closeShoeSelectionModal() {
            document.getElementById('shoeSelectionModal').classList.remove('active');
        }

        function openShoeSelectionModalForEdit() {
            openShoeSelectionModal();
            document.getElementById('shoeSelectionModal').dataset.mode = 'edit';
        }

        function displayShoeVariants(query = '') {
            const shoes = getShoes();
            const container = document.getElementById('shoeSelectionResults');
            
            let filteredVariants = [];
            shoes.forEach(shoe => {
                shoe.inventory.forEach(inv => {
                    const matchesQuery = !query || 
                        shoe.name.toLowerCase().includes(query) ||
                        (shoe.atno || '').toLowerCase().includes(query) ||
                        inv.color.toLowerCase().includes(query) ||
                        inv.size.toLowerCase().includes(query);
                    
                    if (matchesQuery) {
                        filteredVariants.push({
                            ...inv,
                            shoeId: shoe.id,
                            shoeName: shoe.name,
                            atno: shoe.atno || 'N/A',
                            cost: shoe.cost || 0
                        });
                    }
                });
            });

            if (filteredVariants.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3;">No variants found</p>';
                return;
            }

            container.innerHTML = filteredVariants.map(variant => `
                <div class="variant-card" data-variant='${JSON.stringify(variant)}'>
                    <div class="cart-item-header">${variant.shoeName}</div>
                    <div class="variant-info">
                        <strong>ATNO:</strong> ${variant.atno}<br>
                        <strong>Color:</strong> ${variant.color}<br>
                        <strong>Size:</strong> ${variant.size}<br>
                        <strong>Available:</strong> ${variant.qty} pairs<br>
                        <strong>Cost:</strong> KSh ${(variant.cost || 0).toFixed(2)}
                    </div>
                    <div class="variant-actions">
                        <input type="number" placeholder="Qty" min="1" max="${variant.qty}" class="sale-qty-input">
                        <input type="number" placeholder="Price" min="0" step="0.01" class="sale-price-input" value="${(variant.cost || 0) * 2}">
                        <button class="btn-success" onclick="addVariantToSale(this)">Add</button>
                    </div>
                </div>
            `).join('');
        }

        function addVariantToSale(btn) {
            const variantCard = btn.closest('.variant-card');
            const variant = JSON.parse(variantCard.dataset.variant);
            const qty = parseInt(variantCard.querySelector('.sale-qty-input').value);
            const price = parseFloat(variantCard.querySelector('.sale-price-input').value);

            if (!qty || qty < 1) {
                alert('Please enter a valid quantity');
                return;
            }
            if (!price || price < 0) {
                alert('Please enter a valid price');
                return;
            }
            if (qty > variant.qty) {
                alert(`Only ${variant.qty} pairs available`);
                return;
            }

            const saleItem = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                shoeId: variant.shoeId,
                shoeName: variant.shoeName,
                atno: variant.atno,
                color: variant.color,
                size: variant.size,
                qty: qty,
                pricePerPair: price,
                total: qty * price
            };

            if (document.getElementById('shoeSelectionModal').dataset.mode === 'edit') {
                saleItemsForEdit.push(saleItem);
                renderEditSaleItems();
            } else {
                currentSaleItems.push(saleItem);
                renderSaleItems();
            }

            variantCard.querySelector('.sale-qty-input').value = '';
            closeShoeSelectionModal();
            delete document.getElementById('shoeSelectionModal').dataset.mode;
        }

        function removeSaleItem(itemId) {
            currentSaleItems = currentSaleItems.filter(item => item.id !== itemId);
            renderSaleItems();
        }

        function removeEditSaleItem(itemId) {
            saleItemsForEdit = saleItemsForEdit.filter(item => item.id !== itemId);
            renderEditSaleItems();
        }

        function renderSaleItems() {
            const container = document.getElementById('saleItemsCart');
            
            if (currentSaleItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3; padding: 30px;">No items added. Click "Add Item to Sale" to begin.</p>';
                updateSaleTotal();
                return;
            }

            container.innerHTML = currentSaleItems.map(item => `
                <div class="cart-item">
                    <div>
                        <div class="cart-item-header">${item.shoeName}</div>
                        <div class="cart-item-detail">ATNO: ${item.atno} | ${item.color} - Size ${item.size}</div>
                    </div>
                    <div>
                        <label>Qty</label>
                        <input type="number" value="${item.qty}" min="1" readonly>
                    </div>
                    <div>
                        <label>Price</label>
                        <input type="number" value="${item.pricePerPair.toFixed(2)}" min="0" step="0.01" readonly>
                    </div>
                    <div>
                        <label>Total</label>
                        <input type="text" value="KSh ${item.total.toFixed(2)}" readonly>
                    </div>
                    <div>
                        <button class="btn-danger" onclick="removeSaleItem('${item.id}')">Remove</button>
                    </div>
                </div>
            `).join('');

            updateSaleTotal();
        }

        function renderEditSaleItems() {
            const container = document.getElementById('editSaleItemsCart');
            
            if (saleItemsForEdit.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3; padding: 30px;">No items in this sale.</p>';
                updateEditSaleTotal();
                return;
            }

            container.innerHTML = saleItemsForEdit.map(item => `
                <div class="cart-item">
                    <div>
                        <div class="cart-item-header">${item.shoeName}</div>
                        <div class="cart-item-detail">ATNO: ${item.atno} | ${item.color} - Size ${item.size}</div>
                    </div>
                    <div>
                        <label>Qty</label>
                        <input type="number" value="${item.qty}" min="1" onchange="updateEditItemQty('${item.id}', this.value)">
                    </div>
                    <div>
                        <label>Price</label>
                        <input type="number" value="${item.pricePerPair.toFixed(2)}" min="0" step="0.01" onchange="updateEditItemPrice('${item.id}', this.value)">
                    </div>
                    <div>
                        <label>Total</label>
                        <input type="text" value="KSh ${item.total.toFixed(2)}" readonly>
                    </div>
                    <div>
                        <button class="btn-danger" onclick="removeEditSaleItem('${item.id}')">Remove</button>
                    </div>
                </div>
            `).join('');

            updateEditSaleTotal();
        }

        function updateEditItemQty(itemId, newQty) {
            const item = saleItemsForEdit.find(i => i.id === itemId);
            if (item) {
                item.qty = parseInt(newQty);
                item.total = item.qty * item.pricePerPair;
                renderEditSaleItems();
            }
        }

        function updateEditItemPrice(itemId, newPrice) {
            const item = saleItemsForEdit.find(i => i.id === itemId);
            if (item) {
                item.pricePerPair = parseFloat(newPrice);
                item.total = item.qty * item.pricePerPair;
                renderEditSaleItems();
            }
        }

        function updateSaleTotal() {
            const grandTotal = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('grandTotal').textContent = `KSh ${grandTotal.toFixed(2)}`;
            document.getElementById('completeSaleBtn').disabled = currentSaleItems.length === 0;
            validatePayment();
        }

        function updateEditSaleTotal() {
            const grandTotal = saleItemsForEdit.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('editGrandTotal').textContent = `KSh ${grandTotal.toFixed(2)}`;
        }

        // Payment calculation
        document.getElementById('mpesaAmount').addEventListener('input', validatePayment);
        document.getElementById('cashAmount').addEventListener('input', validatePayment);

        function validatePayment() {
            const mpesa = parseFloat(document.getElementById('mpesaAmount').value) || 0;
            const cash = parseFloat(document.getElementById('cashAmount').value) || 0;
            const total = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
            const paymentTotal = mpesa + cash;
            
            document.getElementById('paymentStatus').textContent = 
                Math.abs(paymentTotal - total) < 0.01 ? 'BALANCED âœ“' : `UNBALANCED (Diff: KSh ${(paymentTotal - total).toFixed(2)})`;
            document.getElementById('paymentStatus').style.color = 
                Math.abs(paymentTotal - total) < 0.01 ? '#43a047' : '#d32f2f';
        }

        // SALES FORM SUBMIT
        document.getElementById('salesForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (currentSaleItems.length === 0) {
                alert('Please add at least one item to the sale');
                return;
            }

            const saleDate = document.getElementById('saleDate').value;
            const customerName = document.getElementById('customerName').value.trim();
            const mpesa = parseFloat(document.getElementById('mpesaAmount').value) || 0;
            const cash = parseFloat(document.getElementById('cashAmount').value) || 0;
            const grandTotal = currentSaleItems.reduce((sum, item) => sum + item.total, 0);

            if (Math.abs(mpesa + cash - grandTotal) > 0.01) {
                alert(`Payment amounts (KSh ${(mpesa + cash).toFixed(2)}) don't match sale total (KSh ${grandTotal.toFixed(2)})`);
                return;
            }

            // Check and update inventory
            const shoes = getShoes();
            for (let item of currentSaleItems) {
                const shoe = shoes.find(s => s.id === item.shoeId);
                const invItem = shoe.inventory.find(i => i.color === item.color && i.size === item.size);
                
                if (!invItem || invItem.qty < item.qty) {
                    alert(`Insufficient inventory for ${item.shoeName} (${item.color}, Size ${item.size})`);
                    return;
                }
                invItem.qty -= item.qty;
            }
            localStorage.setItem('shoes', JSON.stringify(shoes));

            // Save sale
            const sale = {
                id: Date.now().toString(),
                date: saleDate,
                customerName: customerName || 'N/A',
                items: [...currentSaleItems],
                mpesa: mpesa,
                cash: cash,
                total: grandTotal
            };

            const sales = getSales();
            sales.push(sale);
            localStorage.setItem('sales', JSON.stringify(sales));

            alert('Sale recorded successfully!');
            this.reset();
            document.getElementById('saleDate').valueAsDate = new Date();
            currentSaleItems = [];
            renderSaleItems();
            loadSales();
        });

        // Backward compatible sales getter
        function getSales() {
            const rawSales = JSON.parse(localStorage.getItem('sales') || '[]');
            return rawSales.map(sale => {
                // Backward compatibility: if old format (no items array), convert it
                if (!sale.items && sale.shoeId) {
                    return {
                        id: sale.id,
                        date: sale.date,
                        customerName: sale.customerName || 'N/A',
                        items: [{
                            id: sale.id + '_item',
                            shoeId: sale.shoeId,
                            shoeName: sale.shoeName,
                            atno: sale.atno || 'N/A',
                            color: sale.color,
                            size: sale.size,
                            qty: sale.qty,
                            pricePerPair: sale.pricePerPair,
                            total: sale.total
                        }],
                        mpesa: sale.mpesa || 0,
                        cash: sale.cash || 0,
                        total: sale.total
                    };
                }
                return sale;
            });
        }

        function loadSales() {
            const sales = getSales().sort((a, b) => new Date(b.date) - new Date(a.date));
            const container = document.getElementById('salesList');

            if (sales.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3;">No sales recorded yet</p>';
                return;
            }

            container.innerHTML = sales.slice(0, 20).map(sale => `
                <div class="sale-item">
                    <div class="sale-header">
                        <span>Sale #${sale.id.substring(sale.id.length - 6)}</span>
                        <span>KSh ${sale.total.toFixed(2)}</span>
                    </div>
                    <div class="sale-details">
                        <strong>Date:</strong> ${sale.date} | <strong>Customer:</strong> ${sale.customerName}<br>
                        <strong>Items:</strong> ${sale.items ? sale.items.length : 0} item(s)<br>
                        ${sale.items ? sale.items.map(item => 
                            `${item.qty}x ${item.shoeName} (${item.color}, Size ${item.size}) @ KSh ${item.pricePerPair.toFixed(2)}`
                        ).join('<br>') : ''}
                        <br><strong>Payment:</strong> M-Pesa: KSh ${sale.mpesa.toFixed(2)} | Cash: KSh ${sale.cash.toFixed(2)}
                    </div>
                    <div class="card-actions" style="margin-top: 10px;">
                        <button onclick="editSale('${sale.id}')" class="btn-secondary">Edit Sale</button>
                        <button onclick="deleteSale('${sale.id}')" class="btn-danger">Delete Sale</button>
                    </div>
                </div>
            `).join('');
        }

        function editSale(saleId) {
            const sale = getSales().find(s => s.id === saleId);
            if (!sale) return;

            editingSaleId = saleId;
            saleItemsForEdit = JSON.parse(JSON.stringify(sale.items || [])); // Deep copy
            
            document.getElementById('editSaleDate').value = sale.date;
            document.getElementById('editCustomerName').value = sale.customerName;
            document.getElementById('editMpesaAmount').value = sale.mpesa;
            document.getElementById('editCashAmount').value = sale.cash;
            
            renderEditSaleItems();
            document.getElementById('editSaleModal').classList.add('active');
        }

        function closeEditSaleModal() {
            document.getElementById('editSaleModal').classList.remove('active');
            editingSaleId = null;
            saleItemsForEdit = [];
        }

        function deleteSale(saleId) {
            if (!confirm('Are you sure you want to delete this sale? This will return the items to inventory.')) return;

            const sales = getSales();
            const saleIndex = sales.findIndex(s => s.id === saleId);
            
            if (saleIndex !== -1) {
                // Return items to inventory
                const shoes = getShoes();
                sales[saleIndex].items.forEach(item => {
                    const shoe = shoes.find(s => s.id === item.shoeId);
                    const invItem = shoe.inventory.find(i => i.color === item.color && i.size === item.size);
                    if (invItem) {
                        invItem.qty += item.qty;
                    }
                });
                localStorage.setItem('shoes', JSON.stringify(shoes));

                // Remove sale
                sales.splice(saleIndex, 1);
                localStorage.setItem('sales', JSON.stringify(sales));
                
                loadSales();
                alert('Sale deleted successfully!');
            }
        }

        // EDIT SALE FORM SUBMIT
        document.getElementById('editSaleForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (saleItemsForEdit.length === 0) {
                alert('Please add at least one item to the sale');
                return;
            }

            const saleDate = document.getElementById('editSaleDate').value;
            const customerName = document.getElementById('editCustomerName').value.trim();
            const mpesa = parseFloat(document.getElementById('editMpesaAmount').value) || 0;
            const cash = parseFloat(document.getElementById('editCashAmount').value) || 0;
            const grandTotal = saleItemsForEdit.reduce((sum, item) => sum + item.total, 0);

            if (Math.abs(mpesa + cash - grandTotal) > 0.01) {
                alert(`Payment amounts (KSh ${(mpesa + cash).toFixed(2)}) don't match sale total (KSh ${grandTotal.toFixed(2)})`);
                return;
            }

            const sales = getSales();
            const saleIndex = sales.findIndex(s => s.id === editingSaleId);
            
            if (saleIndex !== -1) {
                // Return old items to inventory
                const shoes = getShoes();
                sales[saleIndex].items.forEach(item => {
                    const shoe = shoes.find(s => s.id === item.shoeId);
                    const invItem = shoe.inventory.find(i => i.color === item.color && i.size === item.size);
                    if (invItem) {
                        invItem.qty += item.qty;
                    }
                });

                // Deduct new items from inventory
                for (let item of saleItemsForEdit) {
                    const shoe = shoes.find(s => s.id === item.shoeId);
                    const invItem = shoe.inventory.find(i => i.color === item.color && i.size === item.size);
                    
                    if (!invItem || invItem.qty < item.qty) {
                        alert(`Insufficient inventory for ${item.shoeName} (${item.color}, Size ${item.size})`);
                        return;
                    }
                    invItem.qty -= item.qty;
                }
                localStorage.setItem('shoes', JSON.stringify(shoes));

                // Update sale
                sales[saleIndex] = {
                    id: editingSaleId,
                    date: saleDate,
                    customerName: customerName || 'N/A',
                    items: [...saleItemsForEdit],
                    mpesa: mpesa,
                    cash: cash,
                    total: grandTotal
                };
                localStorage.setItem('sales', JSON.stringify(sales));

                closeEditSaleModal();
                loadSales();
                alert('Sale updated successfully!');
            }
        });

        // CSV DOWNLOAD AND UPLOAD FUNCTIONS
        function downloadInventoryCSV() {
            const shoes = getShoes();
            if (shoes.length === 0) {
                alert('No inventory data to download');
                return;
            }

            let csv = 'ID,Date,Shoe Name,ATNO,Supplier,Cost Per Pair,Color,Size,Quantity\n';
            
            shoes.forEach(shoe => {
                shoe.inventory.forEach(inv => {
                    csv += `"${shoe.id}","${shoe.date}","${shoe.name}","${shoe.atno}","${shoe.supplier}",${shoe.cost || 0},"${inv.color}","${inv.size}",${inv.qty}\n`;
                });
            });

            downloadCSV(csv, 'inventory_' + new Date().toISOString().split('T')[0] + '.csv');
            alert('Inventory data downloaded successfully!');
        }

        function uploadInventoryCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.split('\n');
                    const shoesMap = {};

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const matches = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                        if (!matches || matches.length < 9) continue;

                        const [id, date, name, atno, supplier, cost, color, size, qty] = matches.map(m => m.replace(/^"|"$/g, '').trim());

                        if (!shoesMap[id]) {
                            shoesMap[id] = {
                                id: id,
                                date: date,
                                name: name,
                                atno: atno,
                                supplier: supplier,
                                cost: parseFloat(cost) || 0,
                                inventory: []
                            };
                        }

                        shoesMap[id].inventory.push({
                            color: color,
                            size: size,
                            qty: parseInt(qty) || 0
                        });
                    }

                    const newShoes = Object.values(shoesMap);
                    if (newShoes.length === 0) {
                        alert('No valid data found in CSV file');
                        return;
                    }

                    if (confirm(`Found ${newShoes.length} shoe(s) in the file. This will add to your existing inventory. Continue?`)) {
                        const existingShoes = getShoes();
                        const combinedShoes = [...existingShoes, ...newShoes];
                        localStorage.setItem('shoes', JSON.stringify(combinedShoes));
                        loadInventory();
                        alert('Inventory data imported successfully!');
                    }
                } catch (error) {
                    alert('Error reading CSV file: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function downloadSalesCSV() {
            const sales = getSales();
            if (sales.length === 0) {
                alert('No sales data to download');
                return;
            }

            let csv = 'Sale ID,Date,Customer Name,Total,M-Pesa,Cash,Item Count\n';
            
            sales.forEach(sale => {
                csv += `"${sale.id}","${sale.date}","${sale.customerName}",${sale.total},${sale.mpesa},${sale.cash},${sale.items ? sale.items.length : 0}\n`;
            });

            downloadCSV(csv, 'sales_' + new Date().toISOString().split('T')[0] + '.csv');
            alert('Sales data downloaded successfully!');
        }

        function uploadSalesCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.split('\n');
                    const salesData = [];

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const matches = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                        if (!matches || matches.length < 7) continue;

                        const [id, date, customerName, total, mpesa, cash, itemCount] = matches.map(m => m.replace(/^"|"$/g, '').trim());

                        salesData.push({
                            id: id,
                            date: date,
                            customerName: customerName,
                            items: [],
                            mpesa: parseFloat(mpesa) || 0,
                            cash: parseFloat(cash) || 0,
                            total: parseFloat(total) || 0
                        });
                    }

                    if (salesData.length === 0) {
                        alert('No valid data found in CSV file');
                        return;
                    }

                    if (confirm(`Found ${salesData.length} sale(s) in the file. This will add to your existing sales records. Continue?`)) {
                        const existingSales = getSales();
                        const combinedSales = [...existingSales, ...salesData];
                        localStorage.setItem('sales', JSON.stringify(combinedSales));
                        loadSales();
                        alert('Sales data imported successfully!');
                    }
                } catch (error) {
                    alert('Error reading CSV file: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function downloadTransfersCSV() {
            const transfers = getTransfers();
            if (transfers.length === 0) {
                alert('No transfer data to download');
                return;
            }

            let csv = 'ID,Date,Location,Shoe ID,Shoe Name,Color,Size,Quantity\n';
            
            transfers.forEach(transfer => {
                csv += `"${transfer.id}","${transfer.date}","${transfer.location}","${transfer.shoeId}","${transfer.shoeName}","${transfer.color}","${transfer.size}",${transfer.qty}\n`;
            });

            downloadCSV(csv, 'transfers_' + new Date().toISOString().split('T')[0] + '.csv');
            alert('Transfer data downloaded successfully!');
        }

        function uploadTransfersCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.split('\n');
                    const transfersData = [];

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const matches = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                        if (!matches || matches.length < 8) continue;

                        const [id, date, location, shoeId, shoeName, color, size, qty] = matches.map(m => m.replace(/^"|"$/g, '').trim());

                        transfersData.push({
                            id: id,
                            date: date,
                            location: location,
                            shoeId: shoeId,
                            shoeName: shoeName,
                            color: color,
                            size: size,
                            qty: parseInt(qty) || 0
                        });
                    }

                    if (transfersData.length === 0) {
                        alert('No valid data found in CSV file');
                        return;
                    }

                    if (confirm(`Found ${transfersData.length} transfer(s) in the file. This will add to your existing transfer records. Continue?`)) {
                        const existingTransfers = getTransfers();
                        const combinedTransfers = [...existingTransfers, ...transfersData];
                        localStorage.setItem('transfers', JSON.stringify(combinedTransfers));
                        loadTransfers();
                        alert('Transfer data imported successfully!');
                    }
                } catch (error) {
                    alert('Error reading CSV file: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // TRANSFER FUNCTIONALITY
        function openTransferSelectionModal() {
            document.getElementById('transferSelectionModal').classList.add('active');
            document.getElementById('transferSelectionSearch').value = '';
            displayTransferVariants();
        }

        function closeTransferSelectionModal() {
            document.getElementById('transferSelectionModal').classList.remove('active');
        }

        function displayTransferVariants(query = '') {
            const shoes = getShoes();
            const container = document.getElementById('transferSelectionResults');
            
            let filteredVariants = [];
            shoes.forEach(shoe => {
                shoe.inventory.forEach(inv => {
                    const matchesQuery = !query || 
                        shoe.name.toLowerCase().includes(query) ||
                        (shoe.atno || '').toLowerCase().includes(query) ||
                        inv.color.toLowerCase().includes(query) ||
                        inv.size.toLowerCase().includes(query);
                    
                    if (matchesQuery) {
                        filteredVariants.push({
                            ...inv,
                            shoeId: shoe.id,
                            shoeName: shoe.name,
                            atno: shoe.atno || 'N/A'
                        });
                    }
                });
            });

            if (filteredVariants.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3;">No variants found</p>';
                return;
            }

            container.innerHTML = filteredVariants.map(variant => `
                <div class="variant-card" data-variant='${JSON.stringify(variant)}'>
                    <div class="cart-item-header">${variant.shoeName}</div>
                    <div class="variant-info">
                        <strong>ATNO:</strong> ${variant.atno}<br>
                        <strong>Color:</strong> ${variant.color}<br>
                        <strong>Size:</strong> ${variant.size}<br>
                        <strong>Available:</strong> ${variant.qty} pairs<br>
                    </div>
                    <div class="variant-actions">
                        <input type="number" placeholder="Qty" min="1" max="${variant.qty}" class="transfer-qty-input">
                        <button class="btn-success" onclick="addVariantToTransfer(this)">Add</button>
                    </div>
                    <button class="add-all-variants-btn" onclick="addAllVariantsToTransfer('${variant.shoeId}')">
                        Add All Variants for This Shoe
                    </button>
                </div>
            `).join('');
        }

        function addVariantToTransfer(btn) {
            const variantCard = btn.closest('.variant-card');
            const variant = JSON.parse(variantCard.dataset.variant);
            const qty = parseInt(variantCard.querySelector('.transfer-qty-input').value);

            if (!qty || qty < 1) {
                alert('Please enter a valid quantity');
                return;
            }
            if (qty > variant.qty) {
                alert(`Only ${variant.qty} pairs available`);
                return;
            }

            const transferItem = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                shoeId: variant.shoeId,
                shoeName: variant.shoeName,
                atno: variant.atno,
                color: variant.color,
                size: variant.size,
                qty: qty
            };

            currentTransferItems.push(transferItem);
            renderTransferItems();

            variantCard.querySelector('.transfer-qty-input').value = '';
            closeTransferSelectionModal();
        }

        function addAllVariantsToTransfer(shoeId) {
            const shoe = getShoes().find(s => s.id === shoeId);
            if (!shoe) return;

            let addedCount = 0;
            shoe.inventory.forEach(inv => {
                // Check if this variant already exists in currentTransferItems
                const exists = currentTransferItems.some(item => 
                    item.shoeId === shoeId && item.color === inv.color && item.size === inv.size
                );
                
                if (!exists) {
                    const transferItem = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        shoeId: shoeId,
                        shoeName: shoe.name,
                        atno: shoe.atno || 'N/A',
                        color: inv.color,
                        size: inv.size,
                        qty: inv.qty // Add all available quantity
                    };
                    currentTransferItems.push(transferItem);
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                alert(`Added ${addedCount} variants of ${shoe.name} to transfer`);
                renderTransferItems();
                closeTransferSelectionModal();
            } else {
                alert('All variants of this shoe are already in the transfer list');
            }
        }

        function removeTransferItem(itemId) {
            currentTransferItems = currentTransferItems.filter(item => item.id !== itemId);
            renderTransferItems();
        }

        function renderTransferItems() {
            const container = document.getElementById('transferItemsCart');
            
            if (currentTransferItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3; padding: 30px;">No items added. Click "Add Item to Transfer" to begin.</p>';
                document.getElementById('completeTransferBtn').disabled = true;
                return;
            }

            container.innerHTML = currentTransferItems.map(item => `
                <div class="cart-item">
                    <div>
                        <div class="cart-item-header">${item.shoeName}</div>
                        <div class="cart-item-detail">ATNO: ${item.atno} | ${item.color} - Size ${item.size}</div>
                    </div>
                    <div>
                        <label>Qty</label>
                        <input type="number" value="${item.qty}" min="1" readonly>
                    </div>
                    <div>
                        <label>&nbsp;</label>
                        <button class="btn-danger" onclick="removeTransferItem('${item.id}')">Remove</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('completeTransferBtn').disabled = false;
        }

        // TRANSFER FORM SUBMIT
        document.getElementById('transferForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (currentTransferItems.length === 0) {
                alert('Please add at least one item to the transfer');
                return;
            }

            const transferDate = document.getElementById('transferDate').value;
            const location = document.getElementById('transferLocation').value.trim();

            if (!location) {
                alert('Please enter a transfer location');
                return;
            }

            // Check and update inventory
            const shoes = getShoes();
            for (let item of currentTransferItems) {
                const shoe = shoes.find(s => s.id === item.shoeId);
                const invItem = shoe.inventory.find(i => i.color === item.color && i.size === item.size);
                
                if (!invItem || invItem.qty < item.qty) {
                    alert(`Insufficient inventory for ${item.shoeName} (${item.color}, Size ${item.size})`);
                    return;
                }
                invItem.qty -= item.qty;
            }
            localStorage.setItem('shoes', JSON.stringify(shoes));

            // Save transfer
            const transfers = getTransfers();
            currentTransferItems.forEach(item => {
                const transfer = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    date: transferDate,
                    location: location,
                    shoeId: item.shoeId,
                    shoeName: item.shoeName,
                    color: item.color,
                    size: item.size,
                    qty: item.qty
                };
                transfers.push(transfer);
            });
            localStorage.setItem('transfers', JSON.stringify(transfers));

            alert('Transfer recorded successfully!');
            this.reset();
            document.getElementById('transferDate').valueAsDate = new Date();
            currentTransferItems = [];
            renderTransferItems();
            loadTransfers();
        });

        function getTransfers() {
            return JSON.parse(localStorage.getItem('transfers') || '[]');
        }

        function loadTransfers() {
            const searchQuery = document.getElementById('transferSearch').value.toLowerCase();
            const fromDate = document.getElementById('transferFromDate').value;
            const toDate = document.getElementById('transferToDate').value;

            let transfers = getTransfers();

            // Apply filters
            if (searchQuery) {
                const terms = searchQuery.split(',').map(t => t.trim()).filter(t => t);
                transfers = transfers.filter(transfer => {
                    return terms.some(term => {
                        const nameMatch = transfer.shoeName.toLowerCase().includes(term.toLowerCase());
                        const atnoMatch = (transfer.atno || '').toLowerCase().includes(term.toLowerCase());
                        const colorMatch = transfer.color.toLowerCase().includes(term.toLowerCase());
                        const sizeMatch = transfer.size.toLowerCase().includes(term.toLowerCase());
                        const locationMatch = transfer.location.toLowerCase().includes(term.toLowerCase());
                        return nameMatch || atnoMatch || colorMatch || sizeMatch || locationMatch;
                    });
                });
            }

            if (fromDate) {
                transfers = transfers.filter(t => t.date >= fromDate);
            }
            if (toDate) {
                transfers = transfers.filter(t => t.date <= toDate);
            }

            const container = document.getElementById('transfersList');

            if (transfers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #c8c6c3;">No transfers found</p>';
                return;
            }

            // Group transfers by ID (multiple items per transfer)
            const transfersById = {};
            transfers.forEach(transfer => {
                if (!transfersById[transfer.id]) {
                    transfersById[transfer.id] = {
                        id: transfer.id,
                        date: transfer.date,
                        location: transfer.location,
                        items: []
                    };
                }
                transfersById[transfer.id].items.push(transfer);
            });

            container.innerHTML = Object.values(transfersById).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20).map(transferGroup => `
                <div class="sale-item">
                    <div class="sale-header">
                        <span>Transfer #${transferGroup.id.substring(transferGroup.id.length - 6)}</span>
                        <span>${transferGroup.location}</span>
                    </div>
                    <div class="sale-details">
                        <strong>Date:</strong> ${transferGroup.date}<br>
                        <strong>Items:</strong> ${transferGroup.items.length} item(s)<br>
                        ${transferGroup.items.map(item => 
                            `${item.qty}x ${item.shoeName} (${item.color}, Size ${item.size})`
                        ).join('<br>')}
                    </div>
                </div>
            `).join('');
        }

        function clearTransferFilters() {
            document.getElementById('transferSearch').value = '';
            document.getElementById('transferFromDate').value = '';
            document.getElementById('transferToDate').value = '';
            loadTransfers();
        }

        // REPORTS
        function generateReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;

            let sales = getSales();
            let transfers = getTransfers();

            if (fromDate) {
                sales = sales.filter(s => s.date >= fromDate);
                transfers = transfers.filter(t => t.date >= fromDate);
            }
            if (toDate) {
                sales = sales.filter(s => s.date <= toDate);
                transfers = transfers.filter(t => t.date <= toDate);
            }

            const totalSales = sales.reduce((sum, s) => sum + s.total, 0);
            const totalMpesa = sales.reduce((sum, s) => sum + s.mpesa, 0);
            const totalCash = sales.reduce((sum, s) => sum + s.cash, 0);
            const totalPairs = sales.reduce((sum, s) => sum + (s.items ? s.items.reduce((a, b) => a + b.qty, 0) : 0), 0);
            
            // Group transfers by ID for counting
            const transferGroups = {};
            transfers.forEach(t => {
                if (!transferGroups[t.id]) {
                    transferGroups[t.id] = { date: t.date, location: t.location, items: [] };
                }
                transferGroups[t.id].items.push(t);
            });
            const totalTransferPairs = transfers.reduce((sum, t) => sum + t.qty, 0);

            // Sales by date
            const salesByDate = {};
            sales.forEach(s => {
                if (!salesByDate[s.date]) {
                    salesByDate[s.date] = { total: 0, mpesa: 0, cash: 0, pairs: 0 };
                }
                salesByDate[s.date].total += s.total;
                salesByDate[s.date].mpesa += s.mpesa;
                salesByDate[s.date].cash += s.cash;
                salesByDate[s.date].pairs += s.items ? s.items.reduce((a, b) => a + b.qty, 0) : 0;
            });

            // Transfers by location
            const transfersByLocation = {};
            Object.values(transferGroups).forEach(group => {
                if (!transfersByLocation[group.location]) {
                    transfersByLocation[group.location] = { pairs: 0, count: 0 };
                }
                transfersByLocation[group.location].pairs += group.items.reduce((sum, item) => sum + item.qty, 0);
                transfersByLocation[group.location].count++;
            });

            const container = document.getElementById('reportContent');
            container.innerHTML = `
                <div class="report-card">
                    <h2 style="margin-bottom: 20px;">Sales Summary</h2>
                    <div class="report-stat">
                        <span class="stat-label">Total Sales Amount</span>
                        <span class="stat-value">KSh ${totalSales.toFixed(2)}</span>
                    </div>
                    <div class="report-stat">
                        <span class="stat-label">Total M-Pesa Payments</span>
                        <span class="stat-value">KSh ${totalMpesa.toFixed(2)}</span>
                    </div>
                    <div class="report-stat">
                        <span class="stat-label">Total Cash Payments</span>
                        <span class="stat-value">KSh ${totalCash.toFixed(2)}</span>
                    </div>
                    <div class="report-stat">
                        <span class="stat-label">Total Pairs Sold</span>
                        <span class="stat-value">${totalPairs}</span>
                    </div>
                    <div class="report-stat">
                        <span class="stat-label">Number of Transactions</span>
                        <span class="stat-value">${sales.length}</span>
                    </div>
                </div>

                <div class="report-card">
                    <h2 style="margin-bottom: 20px;">Transfer Summary</h2>
                    <div class="report-stat">
                        <span class="stat-label">Total Pairs Transferred</span>
                        <span class="stat-value">${totalTransferPairs}</span>
                    </div>
                    <div class="report-stat">
                        <span class="stat-label">Total Transfers</span>
                        <span class="stat-value">${Object.keys(transferGroups).length}</span>
                    </div>
                    ${Object.keys(transfersByLocation).length > 0 ? `
                        <h3 style="margin-top: 20px; margin-bottom: 10px; color: #f5f3f0;">By Location</h3>
                        ${Object.entries(transfersByLocation).map(([location, data]) => `
                            <div class="report-stat">
                                <span class="stat-label">${location}</span>
                                <span class="stat-value">${data.pairs} pairs (${data.count} transfers)</span>
                            </div>
                        `).join('')}
                    ` : ''}
                </div>

                <div class="report-card">
                    <h2 style="margin-bottom: 20px;">Sales by Date</h2>
                    ${Object.entries(salesByDate).sort((a, b) => new Date(b[0]) - new Date(a[0])).map(([date, data]) => `
                        <div class="report-stat">
                            <span class="stat-label">${date}</span>
                            <span class="stat-value">KSh ${data.total.toFixed(2)}</span>
                        </div>
                        <div style="padding-left: 20px; font-size: 13px; color: #a8a6a3; margin-bottom: 10px;">
                            M-Pesa: KSh ${data.mpesa.toFixed(2)} | Cash: KSh ${data.cash.toFixed(2)} | ${data.pairs} pairs sold
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function downloadReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;

            let sales = getSales();
            let transfers = getTransfers();

            if (fromDate) {
                sales = sales.filter(s => s.date >= fromDate);
                transfers = transfers.filter(t => t.date >= fromDate);
            }
            if (toDate) {
                sales = sales.filter(s => s.date <= toDate);
                transfers = transfers.filter(t => t.date <= toDate);
            }

            let csvContent = 'SALES REPORT\n\n';
            csvContent += 'Date,Customer,Shoe Name,Color,Size,Quantity,Price per Pair,Total\n';
            
            sales.forEach(sale => {
                if (sale.items) {
                    sale.items.forEach(item => {
                        csvContent += `${sale.date},${sale.customerName},${item.shoeName},${item.color},${item.size},${item.qty},${item.pricePerPair.toFixed(2)},${item.total.toFixed(2)}\n`;
                    });
                }
            });

            csvContent += '\n\nTRANSFERS REPORT\n\n';
            csvContent += 'Date,Location,Shoe Name,Color,Size,Quantity\n';
            
            const transferGroups = {};
            transfers.forEach(t => {
                if (!transferGroups[t.id]) {
                    transferGroups[t.id] = { date: t.date, location: t.location, items: [] };
                }
                transferGroups[t.id].items.push(t);
            });
            
            Object.values(transferGroups).forEach(group => {
                group.items.forEach(item => {
                    csvContent += `${group.date},${group.location},${item.shoeName},${item.color},${item.size},${item.qty}\n`;
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize
        loadInventory();
        loadTransfers(); // Load transfers on page load
    </script>
</body>
</html>
